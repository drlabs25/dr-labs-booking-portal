<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Booking</title>
<link rel="stylesheet" href="style.css">
<script src="script.js"></script>
<style>
.small-btn { padding: 5px 10px; font-size: 12px; border-radius: 50%; border: none; cursor: pointer; }
.cancel { background: red; color: white; }
.edit { background: orange; color: white; }
.paid { background: green; color: white; }
.flex { display: flex; gap: 10px; flex-wrap: wrap; }
.flex input, .flex select { flex: 1; }

/* Container for top-left buttons */
#topLeftBtns {
    position: fixed;
    top: 10px;
    left: 20px;
    display: flex;
    gap: 6px;   /* space between buttons */
    z-index: 999;
}

/* Style for both Back & Home buttons */
#topLeftBtns button {
    padding: 4px 8px;      
    font-size: 11px;       
    border-radius: 4px;    
    border: 1px solid #007bff;
    background: #e6f0ff;   
    color: #007bff;        
    cursor: pointer;
}

#topLeftBtns button:hover {
    background: #cce0ff;   /* hover effect */
}
</style>
</head>
<body>
    <header>
  <div style="position:fixed; top:10px; right:20px; text-align:right;">
      <div><strong id="agentNameLabel"></strong></div>
      <div><small id="dateTimeLabel"></small></div>
  </div>
</header>

<div id="topLeftBtns">
  <button id="backBtn" onclick="goBack()">‚¨Ö Back</button>
  <button id="homeBtn" onclick="goHome()">üè† Home</button>
</div>
<div class="container">
<h2>Booking Form</h2>

<!-- Search Section -->
<div class="flex">
    <input type="number" id="searchCustNumber" placeholder="Customer Number (10 digits)" maxlength="10" oninput="validateCustomerNumber(this)">
<button onclick="searchCustomer()">Search</button>
<button id="createBookingBtn" onclick="showBookingForm()" disabled>Create Booking</button>
    <button id="confirmBtn" style="display:none;" onclick="confirmBooking()">Confirm Booking</button>
</div>
<!-- Booking History -->
<div id="history" style="display:none;">
    <h3>Booking History</h3>
    <div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Customer Number</th>
                <th>Customer Name</th>
                <th>Preferred Date & Time</th>
                <th>Technician Name</th>
                <th>Created Date & Time</th>
                <th>Agent Name</th>
                <th>Status</th>
                <th>Edit</th>
                <th>Cancel</th>
                <th>Paid</th>
            </tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
    </div>
</div>

<!-- Booking Form Fields -->

<!-- Booking Form Fields -->
<div id="bookingForm" style="display:none; margin-top:20px;">

    <!-- Customer Information -->
    <fieldset style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:6px;">
        <legend><b>Customer Information</b></legend>
        <div class="flex">
            <input type="text" id="custNumber" placeholder="Customer Number (10 digits)" maxlength="10" required>
            <input type="text" id="custName" placeholder="Customer Name" required>
            <input type="date" id="dob" placeholder="Date of Birth" onchange="calcAge()">
            <input type="number" id="age" placeholder="Age" required>
            <select id="gender" required>
                <option value="">--Gender--</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
        </div>
        <div class="flex">
            <textarea id="address" placeholder="Address" maxlength="500" required></textarea>
            <input type="text" id="location" placeholder="Location" maxlength="100" required>
            <select id="city" required>
                <option value="">--Select City--</option>
                <option>Chennai</option>
                <option>Bangalore</option>
                <option>Hyderabad</option>
                <option>Mumbai</option>
                <option>Delhi</option>
                <option>Coimbatore</option>
            </select>
            <input type="number" id="pincode" placeholder="Pincode (6 digits)" maxlength="6" required>
        </div>
    </fieldset>

    <!-- Assigning Information -->
    <fieldset style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:6px;">
        <legend><b>Assigning Information</b></legend>
        <div class="flex">
            <select id="phleboList" onchange="checkPhleboAvailability()" required>
                <option value="">--Select Phlebo--</option>
            </select>
            <input type="date" id="prefDate" min="" onchange="checkPhleboAvailability()" required>
            <select id="prefTime" onchange="checkPhleboAvailability()" required></select>
        </div>
    </fieldset>

    <!-- Test, Package & Amount Details -->
    <fieldset style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:6px;">
        <legend><b>Test, Package & Amount Details</b></legend>
        
        <!-- Tests -->
        <label>Tests</label>
        <input type="text" placeholder="Search Test" oninput="loadTests(this.value)">
        <div id="testList"></div>
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr><th>Test Name</th><th>Cost</th><th>Action</th></tr>
            </thead>
            <tbody id="selectedTestsBody"></tbody>
        </table>

        <!-- Packages -->
        <label>Packages</label>
        <input type="text" placeholder="Search Package" oninput="loadPackages(this.value)">
        <div id="packageList"></div>
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr><th>Package Name</th><th>Cost</th><th>Action</th></tr>
            </thead>
            <tbody id="selectedPackagesBody"></tbody>
        </table>

        <!-- Amounts -->
        <div class="flex">
            <input type="number" id="totalAmount" placeholder="Total Amount" readonly>
            <select id="discountList" onchange="recalculateTotal()">
                <option value="0">No Discount</option>
                <option value="5">5%</option>
                <option value="10">10%</option>
                <option value="15">15%</option>
                <option value="20">20%</option>
            </select>
            <input type="number" id="techCharge" placeholder="Technician Charge" oninput="recalculateTotal()">
            <input type="number" id="totalToPay" placeholder="Total To Pay" readonly>
        </div>
    </fieldset>

    <!-- Submit -->
    <button type="button" onclick="createBooking()">Submit</button>
</div>
<div id="bookingForm" style="display:none;">
    <h3>New Booking</h3>
    <!-- Hidden bookingId for edit mode -->
    <input type="hidden" id="bookingId">
    <!-- ‚úÖ Customer Number belongs here -->
    <input 
  type="text" 
  id="custNumber" 
  placeholder="Enter 10-digit number" 
  maxlength="10" 
  inputmode="numeric" 
  pattern="\d{10}" 
  required
>
    <input type="text" id="custName" placeholder="Main Customer Name" required>
    <input type="date" id="dob" placeholder="Date of Birth" onchange="calcAge()">
    <input type="number" id="age" placeholder="Age" required>
    <select id="gender" required>
    <option value="">--Select Gender--</option>
    <option value="Male">Male</option>
    <option value="Female">Female</option>

    </select>
    <textarea id="address" placeholder="Address" maxlength="500" required></textarea>
    <input type="text" id="location" placeholder="Location" maxlength="100" required>
    <select id="city">
        <option value="">--Select City--</option>
        <option>Chennai</option>
        <option>Bangalore</option>
        <option>Hyderabad</option>
        <option>Mumbai</option>
        <option>Delhi</option>
        <option>Coimbatore</option>
    </select>
    <select id="phleboList" onchange="checkPhleboAvailability()">
        <option value="">--Select Phlebo--</option>
    </select>
    <input type="number" id="pincode" placeholder="Pincode (6 digits)" maxlength="6" required>
    <input type="date" id="prefDate" min="" onchange="checkPhleboAvailability()">
    <select id="prefTime" onchange="checkPhleboAvailability()"></select>

    <!-- Test selection -->
    <label>Tests</label>
    <input type="text" placeholder="Search Test" oninput="loadTests(this.value)">
    <div id="testList"></div>
    <div id="selectedTests">
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr>
                    <th>Test Name</th>
                    <th>Cost</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="selectedTestsBody"></tbody>
        </table>
    </div>

    <!-- Main Booking Preview Table -->
    <div id="mainBookingPreview" style="display:none; float:right; width:35%; margin-top:20px;">
        <h3>Main Booking</h3>
        <table border="1" style="width:100%;">
            <thead>
                <tr>
                    <th>Customer Name</th>
                    <th>Preferred Date & Time</th>
                    <th>Total Cost</th>
                </tr>
            </thead>
            <tbody id="mainBookingPreviewBody"></tbody>
        </table>
    </div>

    <!-- Package selection -->
    <label>Packages</label>
    <input type="text" placeholder="Search Package" oninput="loadPackages(this.value)">
    <div id="packageList"></div>
    <div id="selectedPackages">
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr>
                    <th>Package Name</th>
                    <th>Cost</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="selectedPackagesBody"></tbody>
        </table>
    </div>

    <input type="number" id="totalAmount" placeholder="Total Amount" readonly>

    <select id="discountList" onchange="recalculateTotal()">
        <option value="0">No Discount</option>
        <option value="5">5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20">20%</option>
    </select>

    <input type="number" id="techCharge" placeholder="Technician Charge" oninput="recalculateTotal()">
    <input type="number" id="totalToPay" placeholder="Total Amount to be Paid" readonly>

    <!-- ‚úÖ Only one pair of buttons -->
    <!-- Buttons for booking form -->
<button type="button" id="submitBtn" onclick="createBooking()">Submit</button>
<button type="button" id="updateBtn" style="display:none;" onclick="updateBookingForm()">Update</button>
</div>

<!-- ‚úÖ Add More button OUTSIDE bookingForm -->
<button type="button" id="addMoreBtn" style="display:none; margin-top:10px;" onclick="addSubBooking()">Add More</button>


<script>
window.onload = function() {
    let today = new Date().toISOString().split("T")[0];
    document.getElementById("prefDate").setAttribute("min", today);

    let timeSelect = document.getElementById('prefTime');
    let startHour = 6, endHour = 18;
    for (let h = startHour; h < endHour; h++) {
        let times = [`${h}:00`, `${h}:30`];
        for (let i = 0; i < times.length; i++) {
            let nextH = h + (i === 0 ? 0 : 1);
            let nextM = (i === 0 ? ":30" : ":00");
            let display = `${times[i]} - ${nextH}${nextM}`;
            let opt = document.createElement("option");
            opt.text = display;
            timeSelect.add(opt);
        }
    }
    loadPhlebos();
};

function validateCustomerNumber(input) {
    input.value = input.value.replace(/[^0-9]/g, '');
    document.getElementById("createBookingBtn").disabled = (input.value.length !== 10);
}

function validateAndShowBookingForm() {
    let num = document.getElementById("custNumber").value.trim();

    // Check for exactly 10 numeric digits
    if (num.length !== 10 || !/^\d+$/.test(num)) {
        alert("Please enter a valid 10-digit Customer Number");
        return;
    }

    // Clear form inputs except the customer number
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea").forEach(el => {
        if (el.id !== "custNumber") el.value = "";
    });

    // ‚úÖ Show the booking form
    document.getElementById("bookingForm").style.display = "block";

    // Hide booking history if it‚Äôs visible
    document.getElementById("history").style.display = "none";
}

function showBookingForm() {
    let num = document.getElementById("searchCustNumber").value.trim();

    if (num.length !== 10 || !/^\d+$/.test(num)) {
        alert("Please enter a valid 10-digit Customer Number");
        return;
    }

    // Put number into the booking form‚Äôs custNumber field
    document.getElementById("custNumber").value = num;
    document.getElementById("custNumber").readOnly = true; // freeze it

    // Reset other fields
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea").forEach(el => {
        if (el.id !== "custNumber" && el.id !== "bookingId") el.value = "";
    });

    document.getElementById("selectedTestsBody").innerHTML = "";
    document.getElementById("selectedPackagesBody").innerHTML = "";
    document.getElementById("totalAmount").value = "";
    document.getElementById("techCharge").value = "";
    document.getElementById("totalToPay").value = "";
    document.getElementById("discountList").value = "0";

    // ‚úÖ Finally show the form
    document.getElementById("bookingForm").style.display = "block";
    document.getElementById("history").style.display = "none";
}

function loadTests(query) {
    query = (query || "").trim();
    if (query.length < 2) {
        document.getElementById("testList").innerHTML = "";
        return;
    }
    fetch(`${API_URL}?action=getTests&search=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(tests => {
            let html = "";
            tests.forEach(t => {
                html += `<div><button type="button" onclick="addSelectedTest('${t.code}','${t.name}','${t.cost}')">${t.name} - ‚Çπ${t.cost}</button></div>`;
            });
            document.getElementById("testList").innerHTML = html;
        });
}

function loadPackages(query) {
    query = (query || "").trim();
    if (query.length < 2) {
        document.getElementById("packageList").innerHTML = "";
        return;
    }
    fetch(`${API_URL}?action=getPackages&search=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(packages => {
            let html = "";
            packages.forEach(p => {
                html += `<div><button type="button" onclick="addSelectedPackage('${p.code}','${p.name}','${p.cost}')">${p.name} - ‚Çπ${p.cost}</button></div>`;
            });
            document.getElementById("packageList").innerHTML = html;
        });
}

function addSelectedTest(code, name, cost) {
    if (!document.getElementById("test_" + code)) {
        let tr = document.createElement("tr");
        tr.id = "test_" + code;
        tr.innerHTML = `
            <td>${name}</td>
            <td>‚Çπ${cost}</td>
            <td><button type="button" onclick="removeSelected('test_${code}')">Remove</button></td>
            <input type="hidden" class="selected-test" value="${code}|${cost}">
        `;
        document.getElementById("selectedTestsBody").appendChild(tr);
    }
    document.getElementById("testList").innerHTML = "";
    recalculateTotal();
}

function addSelectedPackage(code, name, cost) {
    if (!document.getElementById("package_" + code)) {
        let tr = document.createElement("tr");
        tr.id = "package_" + code;
        tr.innerHTML = `
            <td>${name}</td>
            <td>‚Çπ${cost}</td>
            <td><button type="button" onclick="removeSelected('package_${code}')">Remove</button></td>
            <input type="hidden" class="selected-package" value="${code}|${cost}">
        `;
        document.getElementById("selectedPackagesBody").appendChild(tr);
    }
    document.getElementById("packageList").innerHTML = "";
    recalculateTotal();
}

function removeSelected(id) {
    document.getElementById(id).remove();
    recalculateTotal();
}

function calcAge() {
    let dob = document.getElementById("dob").value;
    if (dob) {
        let birth = new Date(dob);
        let today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        let m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        document.getElementById("age").value = age;
    }
}

function recalculateTotal() {
    let testsCost = 0;
    document.querySelectorAll(".selected-test").forEach(item => {
        testsCost += parseFloat(item.value.split("|")[1]) || 0;
    });

    let packagesCost = 0;
    document.querySelectorAll(".selected-package").forEach(item => {
        packagesCost += parseFloat(item.value.split("|")[1]) || 0;
    });

    let totalAmount = testsCost + packagesCost;
    document.getElementById("totalAmount").value = totalAmount.toFixed(2);

    let discountPercent = parseFloat(document.getElementById("discountList").value) || 0;
    let techCharge = parseFloat(document.getElementById("techCharge").value) || 0;

    let discountedPart = (totalAmount - packagesCost) - ((discountPercent / 100) * (totalAmount - packagesCost));
    let totalToPay = discountedPart + packagesCost + techCharge;

    document.getElementById("totalToPay").value = totalToPay.toFixed(2);
}

function searchCustomer() {
    let num = document.getElementById("searchCustNumber").value.trim();
    if (num.length !== 10) {
        alert("Enter a valid 10-digit Customer Number");
        return;
    }
    fetch(`${API_URL}?action=searchBookings&customerNumber=${encodeURIComponent(num)}`)
        .then(res => res.json())
        .then(bookings => {
            const body = document.getElementById("historyBody");
            body.innerHTML = "";
            if (bookings.length === 0) {
                alert("No booking history for this number");
                return;
            }
            document.getElementById("history").style.display = 'block';
            bookings.forEach(b => {
    const tr = document.createElement("tr");

    if (b.status && b.status.toLowerCase() === "paid") {
        tr.style.backgroundColor = "lightgreen";
    } else if (b.status && b.status.toLowerCase() === "cancel") {
        tr.style.backgroundColor = "lightcoral";
        tr.style.color = "white";
    } else if (b.status && b.status.toLowerCase() === "confirm") {
        tr.style.backgroundColor = "lightblue";
    }

    // ‚úÖ Control Edit button based on status
    let editBtn = "";
    if (b.status && b.status.toLowerCase() === "confirm") {
        editBtn = `<button class="small-btn edit" onclick="editBooking('${b.bookingId}')">E</button>`;
    } else {
        editBtn = `<button class="small-btn edit" disabled>E</button>`;
    }

    tr.innerHTML = `
        <td>${b.customerNumber}</td>
        <td>${b.name}</td>
        <td>${b.dateTime}</td>
        <td>${b.phlebo}</td>
        <td>${b.createdDateTime}</td>
        <td>${b.agent}</td>
        <td>${b.status || ''}</td>
        <td>${editBtn}</td>
        <td><button class="small-btn cancel" onclick="updateStatus('${b.bookingId}','Cancel')">X</button></td>
        <td><button class="small-btn paid" onclick="updateStatus('${b.bookingId}','Paid')">P</button></td>
    `;
    body.appendChild(tr);
});

// ‚úÖ Updated: Instant color change when status updates
function updateStatus(bookingId, status) {
    if (!confirm(`Are you sure you want to mark this booking as ${status}?`)) return;

    fetch(`${API_URL}?action=updateBookingStatus&bookingId=${encodeURIComponent(bookingId)}&status=${encodeURIComponent(status)}&t=${Date.now()}`)
        .then(res => res.json())
        .then(data => {
            console.log("Update Status Response:", data);
            if (data.success) {
                alert(`Booking marked as ${status}`);

                let row = [...document.querySelectorAll("#historyBody tr")]
                    .find(tr => tr.innerHTML.includes(bookingId));

                if (row) {
                    let statusCell = row.querySelector("td:nth-child(7)");
                    if (statusCell) statusCell.textContent = status;

                    if (status.toLowerCase() === "paid") {
                        row.style.backgroundColor = "lightgreen";
                        row.style.color = "";
                    } else if (status.toLowerCase() === "cancel") {
                        row.style.backgroundColor = "lightcoral";
                        row.style.color = "white";
                    } else if (status.toLowerCase() === "confirm") {
                        row.style.backgroundColor = "lightblue";
                        row.style.color = "";
                    }
                }
            } else {
                alert("Failed to update status: " + (data.message || "Unknown error"));
            }
        })
        .catch(err => {
            console.error("Error updating status:", err);
            alert("Error updating status. Check console for details.");
        });
}

function createBooking() {
    // Reset all borders first
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea")
        .forEach(el => el.style.border = "");

    let isValid = true;
    function markInvalid(id) {
        document.getElementById(id).style.border = "2px solid red";
        isValid = false;
    }

    let custNumber = document.getElementById("custNumber").value.trim();
    if (custNumber.length !== 10 || !/^\d+$/.test(custNumber)) markInvalid("custNumber");

    if (!document.getElementById("custName").value.trim()) markInvalid("custName");
    if (!document.getElementById("age").value.trim()) markInvalid("age");
    if (!document.getElementById("gender").value) markInvalid("gender");
    if (!document.getElementById("address").value.trim()) markInvalid("address");
    if (!document.getElementById("location").value.trim()) markInvalid("location");
    if (!document.getElementById("city").value) markInvalid("city");
    if (!document.getElementById("phleboList").value) markInvalid("phleboList");

    let pincode = document.getElementById("pincode").value.trim();
    if (pincode.length !== 6 || !/^\d+$/.test(pincode)) markInvalid("pincode");

    if (!document.getElementById("prefDate").value) markInvalid("prefDate");
    if (!document.getElementById("prefTime").value) markInvalid("prefTime");

    let tests = getSelectedTests();
    let packages = getSelectedPackages();
    if (!tests && !packages) {
        document.querySelector("#testList")?.style.setProperty("border", "2px solid red", "important");
        document.querySelector("#packageList")?.style.setProperty("border", "2px solid red", "important");
        isValid = false;
    }

    if (!document.getElementById("discountList").value) markInvalid("discountList");
    if (!document.getElementById("techCharge").value.trim()) markInvalid("techCharge");

    if (!isValid) {
        alert("Please fill all required fields.");
        return;
    }

    // ‚úÖ Always generate NEW bookingId (avoid overwrite)
    let newBookingId = "BKG_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

    let params = new URLSearchParams({
        action: "saveBooking",
        bookingId: newBookingId,
        customerNumber: custNumber,
        mainCustomerName: document.getElementById("custName").value.trim(),
        dob: document.getElementById("dob").value,
        age: document.getElementById("age").value.trim(),
        gender: document.getElementById("gender").value,
        address: document.getElementById("address").value.trim(),
        location: document.getElementById("location").value.trim(),
        city: document.getElementById("city").value,
        phleboName: document.getElementById("phleboList").value,
        pincode: pincode,
        preferredDate: document.getElementById("prefDate").value,
        preferredTime: document.getElementById("prefTime").value,
        tests: tests,
        packages: packages,
        totalAmount: document.getElementById("totalAmount").value,
        discount: document.getElementById("discountList").value,
        techCharge: document.getElementById("techCharge").value,
        totalToPay: document.getElementById("totalToPay").value,
        agentName: localStorage.getItem("agentName") || "",
    });

    fetch(`${API_URL}?${params.toString()}`)
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById("bookingId").value = newBookingId;

            // Decide label (Main or Sub Booking)
            let label;
            if (bookingList.length === 0) {
                label = "Main Booking";
            } else {
                subBookingCounter++;
                label = `Sub Booking ${subBookingCounter}`;
            }

            // Push into bookingList
            bookingList.push({
                type: label,
                name: document.getElementById("custName").value.trim(),
                datetime: `${document.getElementById("prefDate").value} ${document.getElementById("prefTime").value}`,
                cost: document.getElementById("totalToPay").value
            });

            // Render the table
            renderBookingTable();

            // Hide booking form after submit
            document.getElementById("bookingForm").style.display = "none";

            // Show buttons
            document.getElementById("addMoreBtn").style.display = "inline-block";
            document.getElementById("confirmBtn").style.display = "inline-block";

            alert(label + " saved! ID: " + newBookingId);
        } else {
            alert("Failed to save booking.");
        }
    })
    .catch(err => {
        console.error("Booking save error:", err);
        alert("Something went wrong while saving booking!");
    });
}
    function updateBookingForm() {
    let bookingId = document.getElementById("bookingId").value.trim();
    if (!bookingId) {
        alert("Booking ID missing, cannot update!");
        return;
    }

    let custNumber = document.getElementById("custNumber").value.trim();
    if (custNumber.length !== 10 || !/^\d+$/.test(custNumber)) {
        alert("Please enter a valid 10-digit Customer Number");
        return;
    }

    let params = new URLSearchParams({
        action: "updateBooking",
        bookingId: bookingId,
        customerNumber: custNumber,
        mainCustomerName: document.getElementById("custName").value.trim(),
        dob: document.getElementById("dob").value,
        age: document.getElementById("age").value.trim(),
        gender: document.getElementById("gender").value,
        address: document.getElementById("address").value.trim(),
        location: document.getElementById("location").value.trim(),
        city: document.getElementById("city").value,
        phleboName: document.getElementById("phleboList").value,
        pincode: document.getElementById("pincode").value,
        preferredDate: document.getElementById("prefDate").value,
        preferredTime: document.getElementById("prefTime").value,
        tests: getSelectedTests(),
        packages: getSelectedPackages(),
        totalAmount: document.getElementById("totalAmount").value,
        discount: document.getElementById("discountList").value,
        techCharge: document.getElementById("techCharge").value,
        totalToPay: document.getElementById("totalToPay").value,
        agentName: localStorage.getItem("agentName") || ""
    });

    fetch(`${API_URL}?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Booking updated successfully!");

                // Reset buttons
                document.getElementById("submitBtn").style.display = "inline-block";
                document.getElementById("updateBtn").style.display = "none";

                // Clear bookingId after update
                document.getElementById("bookingId").value = "";

                // Refresh booking history table
                searchCustomer();
            } else {
                alert("Failed to update booking!");
            }
        })
        .catch(err => {
            console.error("Update error:", err);
            alert("Error updating booking!");
        });
}
// Render all bookings into the table
function renderBookingTable() {
    const body = document.getElementById("mainBookingPreviewBody");
    body.innerHTML = "";
    bookingList.forEach(b => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${b.type}: ${b.name}</td>
            <td>${b.datetime}</td>
            <td>‚Çπ${b.cost}</td>
        `;
        body.appendChild(tr);
    });
    document.getElementById("mainBookingPreview").style.display = "block";
}

function confirmBooking() {
    if (bookingList.length === 0) {
        alert("No bookings to confirm!");
        return;
    }

    // ‚úÖ Take customer number from the form
    const customerNumber = document.getElementById("custNumber").value.trim();

    if (!/^\d{10}$/.test(customerNumber)) {
        alert("Missing or invalid customer number!");
        return;
    }

    // üîπ Call backend
    fetch(`${API_URL}?action=confirmBooking&customerNumber=${encodeURIComponent(customerNumber)}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("All bookings confirmed successfully!");

                // ‚úÖ Clear both search + form numbers
                document.getElementById("searchCustNumber").value = "";
                document.getElementById("custNumber").value = "";

                // ‚úÖ Hide Add More + Confirm buttons
                document.getElementById("addMoreBtn").style.display = "none";
                document.getElementById("confirmBtn").style.display = "none";

                // ‚úÖ Clear booking preview
                document.getElementById("mainBookingPreviewBody").innerHTML = "";
                document.getElementById("mainBookingPreview").style.display = "none";

                // ‚úÖ Hide booking form
                document.getElementById("bookingForm").style.display = "none";

                // ‚úÖ Reset booking state
                bookingList = [];
                subBookingCounter = 0;
                mainBookingData = null;

                // ‚úÖ Reset button back to Main Booking mode
                const createBtn = document.getElementById("createBookingBtn");
                if (createBtn) {
                    createBtn.textContent = "Create Booking";
                    createBtn.onclick = showBookingForm;
                }

                // ‚úÖ Unfreeze all fields for fresh Main Booking
                ["custNumber","address","location","city","phleboList","pincode","prefDate","prefTime"].forEach(id => {
                    let el = document.getElementById(id);
                    if (!el) return;
                    el.readOnly = false;
                    el.disabled = false;
                    el.style.backgroundColor = ""; // reset styling
                });

            } else {
                alert("Failed to confirm bookings");
            }
        })
        .catch(err => {
            console.error("Confirm booking error:", err);
            alert("Error confirming bookings. Please try again.");
        });
}
function editBooking(bookingId) {
    fetch(`${API_URL}?action=getBookingDetails&bookingId=${encodeURIComponent(bookingId)}`)
        .then(res => res.json())
        .then(data => {
            if (!data.success || !data.booking) {
                alert("Booking details not found!");
                return;
            }

            const booking = data.booking;

            // Fill all basic fields
            document.getElementById("bookingId").value = booking.bookingId || "";
            document.getElementById("custNumber").value = booking.customerNumber || "";
            document.getElementById("custName").value = booking.mainCustomerName || "";
            document.getElementById("dob").value = booking.dob || "";
            document.getElementById("age").value = booking.age || "";
            document.getElementById("gender").value = booking.gender || "";
            document.getElementById("address").value = booking.address || "";
            document.getElementById("location").value = booking.location || "";
            document.getElementById("city").value = booking.city || "";
            document.getElementById("phleboList").value = booking.phleboName || "";
            document.getElementById("pincode").value = booking.pincode || "";
            document.getElementById("prefDate").value = booking.preferredDate || "";
            document.getElementById("prefTime").value = booking.preferredTime || "";
            document.getElementById("totalAmount").value = booking.totalAmount || "";
            document.getElementById("discountList").value = booking.discount || "";
            document.getElementById("techCharge").value = booking.techCharge || "";
            document.getElementById("totalToPay").value = booking.totalToPay || "";

            // Restore tests
            let testsBody = document.getElementById("selectedTestsBody");
            testsBody.innerHTML = "";
            if (booking.tests && Array.isArray(booking.tests)) {
                booking.tests.forEach(test => {
                    let row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${test}</td>
                        <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                    `;
                    testsBody.appendChild(row);
                });
            }

            // Restore packages
            let packagesBody = document.getElementById("selectedPackagesBody");
            packagesBody.innerHTML = "";
            if (booking.packages && Array.isArray(booking.packages)) {
                booking.packages.forEach(pkg => {
                    let row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${pkg}</td>
                        <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                    `;
                    packagesBody.appendChild(row);
                });
            }

            // Show booking form without resetting it
            document.getElementById("bookingForm").style.display = "block";
            document.getElementById("history").style.display = "none";

            // Switch buttons for edit mode
            document.getElementById("submitBtn").style.display = "none";
            document.getElementById("updateBtn").style.display = "inline-block";
        })
        .catch(err => {
            console.error("Error loading booking details:", err);
            alert("Error loading booking details!");
        });
}

function getSelectedTests() {
    let tests = [];
    document.querySelectorAll(".selected-test").forEach(item => {
        tests.push(item.value);
    });
    return tests.join(",");
}

function getSelectedPackages() {
    let packages = [];
    document.querySelectorAll(".selected-package").forEach(item => {
        packages.push(item.value);
    });
    return packages.join(",");
}

function loadPhlebos() {
    fetch(`${API_URL}?action=getPhlebos`)
        .then(res => res.json())
        .then(phlebos => {
            let phleboSelect = document.getElementById("phleboList");
            phlebos.forEach(phlebo => {
                let opt = document.createElement("option");
                opt.value = phlebo.name;
                opt.textContent = phlebo.name;
                phleboSelect.appendChild(opt);
            });
        });
}

function checkPhleboAvailability() {
    let phlebo = document.getElementById("phleboList").value;
    let date = document.getElementById("prefDate").value;
    let time = document.getElementById("prefTime").value;
    let bookingId = document.getElementById("bookingId").value; // added

    if (!phlebo || !date || !time) return;

    fetch(`${API_URL}?action=checkAvailability&phlebo=${encodeURIComponent(phlebo)}&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}&bookingId=${encodeURIComponent(bookingId)}`)
        .then(res => res.json())
        .then(data => {
            if (!data.available) {
                alert("Preferred time not available for this technician. Please choose another time.");
            }
        });
}
    function addMoreBooking() {
    // Reset the form
    document.getElementById("bookingForm").reset();

    // Clear hidden bookingId (new booking, not update)
    document.getElementById("bookingId").value = "";

    // Show the booking form again
    document.getElementById("bookingForm").style.display = "block";

    // Hide the preview until next save
    document.getElementById("mainBookingPreview").style.display = "none";

    // Hide Add More button until next booking saved
    document.getElementById("addMoreBtn").style.display = "none";
}
  function addSubBooking() {
    let custNumber = document.getElementById("custNumber").value.trim();
    if (!custNumber) {
        alert("Customer number missing!");
        return;
    }

    // Call backend to fetch latest main booking
    fetch(`${API_URL}?action=getMainBooking&customerNumber=${custNumber}`)
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert("No main booking found to copy details.");
                return;
            }

            // Clear all fields except customer number
            document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea")
                .forEach(el => {
                    if (el.id === "custNumber" || el.type === "hidden") return;
                    if (el.tagName.toLowerCase() === "select") {
                        el.selectedIndex = 0;
                    } else {
                        el.value = "";
                    }
                });

            // ‚úÖ Reset dynamic sections (tests/packages)
            document.getElementById("selectedTestsBody").innerHTML = "";
            document.getElementById("selectedPackagesBody").innerHTML = "";

            // ‚úÖ Reset totals
            document.getElementById("totalAmount").value = "";
            document.getElementById("techCharge").value = "";
            document.getElementById("totalToPay").value = "";
            document.getElementById("discountList").value = "0";

           // ‚úÖ Pre-fill from main booking
document.getElementById("custNumber").value = custNumber;
document.getElementById("address").value    = data.address;
document.getElementById("location").value   = data.location;
document.getElementById("city").value       = data.city;
document.getElementById("phleboList").value = data.phleboName;
document.getElementById("pincode").value    = data.pincode;

// ‚úÖ Fix preferredDate (convert to YYYY-MM-DD for input type="date")
if (data.preferredDate) {
    let d = new Date(data.preferredDate);
    let yyyy = d.getFullYear();
    let mm = String(d.getMonth() + 1).padStart(2, "0");
    let dd = String(d.getDate()).padStart(2, "0");
    document.getElementById("prefDate").value = `${yyyy}-${mm}-${dd}`;
}

// ‚úÖ Fix preferredTime (input type="time" expects HH:MM in 24hr format)
if (data.preferredTime) {
    document.getElementById("prefTime").value = data.preferredTime;
}

// ‚úÖ Freeze those fields
["custNumber","address","location","city","phleboList","pincode","prefDate","prefTime"].forEach(id => {
    let el = document.getElementById(id);
    if (!el) return;

    if (el.tagName.toLowerCase() === "select" || el.type === "date" || el.type === "time") {
        el.disabled = true;  // disable select/date/time inputs
    } else {
        el.readOnly = true;  // readonly for text/textarea
    }
    el.style.backgroundColor = "#f0f0f0"; // greyed out
});
            // ‚úÖ Show booking form again
            document.getElementById("bookingForm").style.display = "block";

            // ‚úÖ Keep Add More button visible
            document.getElementById("addMoreBtn").style.display = "inline-block";
        })
        .catch(err => {
            console.error("Error fetching main booking:", err);
            alert("Could not fetch main booking details.");
        });
}
</script>
</body>
</html>
