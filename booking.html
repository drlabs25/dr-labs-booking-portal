<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Booking</title>
<link rel="stylesheet" href="style.css">
<script src="script.js"></script>
<style>
.small-btn { padding: 5px 10px; font-size: 12px; border-radius: 50%; border: none; cursor: pointer; }
.cancel { background: red; color: white; }
.edit { background: orange; color: white; }
.paid { background: green; color: white; }
.flex { display: flex; gap: 10px; flex-wrap: wrap; }
.flex input, .flex select { flex: 1; }
</style>
</head>
<body>
<button class="nav-btn back" onclick="goBack()">Back</button>
<button class="nav-btn home" onclick="goHome()">Home</button>
<div class="container">
<h2>Booking Form</h2>

<!-- Search Section -->
<div class="flex">
    <input type="number" id="custNumber" placeholder="Customer Number (10 digits)" maxlength="10" oninput="validateCustomerNumber(this)">
    <button onclick="searchCustomer()">Search</button>
    <button id="createBookingBtn" onclick="validateAndShowBookingForm()" disabled>Create Booking</button>
</div>

<!-- Booking History -->
<div id="history" style="display:none;">
    <h3>Booking History</h3>
    <div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Customer Number</th>
                <th>Customer Name</th>
                <th>Preferred Date & Time</th>
                <th>Technician Name</th>
                <th>Agent Name</th>
                <th>Created Date & Time</th>
                <th>Edit</th>
                <th>Cancel</th>
                <th>Paid</th>
            </tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
    </div>
</div>

<!-- Booking Form Fields -->
<div id="bookingForm" style="display:none;">
    <h3>New Booking</h3>
    <input type="text" id="custName" placeholder="Main Customer Name" required>
    <input type="date" id="dob" placeholder="Date of Birth" onchange="calcAge()">
    <input type="number" id="age" placeholder="Age" required>
    <select id="gender">
        <option>Male</option>
        <option>Female</option>
    </select>
    <textarea id="address" placeholder="Address" maxlength="500" required></textarea>
    <input type="text" id="location" placeholder="Location" maxlength="100" required>
    <select id="city">
        <option>Chennai</option>
        <option>Bangalore</option>
        <option>Hyderabad</option>
        <option>Mumbai</option>
        <option>Delhi</option>
        <option>Coimbatore</option>
    </select>
    <select id="phleboList" onchange="checkPhleboAvailability()">
        <option value="">--Select Phlebo--</option>
    </select>
    <input type="number" id="pincode" placeholder="Pincode (6 digits)" maxlength="6" required>
    <input type="date" id="prefDate" min="" onchange="checkPhleboAvailability()">
    <select id="prefTime" onchange="checkPhleboAvailability()"></select>

    <!-- Test selection -->
    <label>Tests</label>
    <input type="text" placeholder="Search Test" oninput="loadTests(this.value)">
    <div id="testList"></div>
    <div id="selectedTests">
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr>
                    <th>Test Name</th>
                    <th>Cost</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="selectedTestsBody"></tbody>
        </table>
    </div>

    <!-- Package selection -->
    <label>Packages</label>
    <input type="text" placeholder="Search Package" oninput="loadPackages(this.value)">
    <div id="packageList"></div>
    <div id="selectedPackages">
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr>
                    <th>Package Name</th>
                    <th>Cost</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="selectedPackagesBody"></tbody>
        </table>
    </div>

    <input type="number" id="totalAmount" placeholder="Total Amount" readonly>

    <!-- Discount changed to percentage -->
    <select id="discountList" onchange="recalculateTotal()">
        <option value="0">No Discount</option>
        <option value="5">5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20">20%</option>
    </select>

    <input type="number" id="techCharge" placeholder="Technician Charge" oninput="recalculateTotal()">
    <input type="number" id="totalToPay" placeholder="Total Amount to be Paid" readonly>

    <button onclick="createBooking()">Submit</button>
    <button onclick="addSubBooking()">Sub Booking</button>
    <button onclick="confirmBooking()">Confirm Booking</button>
</div>
</div>

<script>
window.onload = function() {
    let today = new Date().toISOString().split("T")[0];
    document.getElementById("prefDate").setAttribute("min", today);

    let timeSelect = document.getElementById('prefTime');
    let startHour = 6, endHour = 18;
    for (let h = startHour; h < endHour; h++) {
        let times = [`${h}:00`, `${h}:30`];
        for (let i = 0; i < times.length; i++) {
            let nextH = h + (i === 0 ? 0 : 1);
            let nextM = (i === 0 ? ":30" : ":00");
            let display = `${times[i]} - ${nextH}${nextM}`;
            let opt = document.createElement("option");
            opt.text = display;
            timeSelect.add(opt);
        }
    }
    loadPhlebos();
};

function validateCustomerNumber(input) {
    input.value = input.value.replace(/[^0-9]/g, '');
    document.getElementById("createBookingBtn").disabled = input.value.length !== 10;
}

function validateAndShowBookingForm() {
    let num = document.getElementById("custNumber").value;
    if (num.length !== 10) {
        alert("Please enter valid Number");
        return;
    }
    showBookingForm();
}

function loadTests(query) {
    query = (query || "").trim();
    if (query.length < 2) { document.getElementById("testList").innerHTML = ""; return; }
    fetch(`${API_URL}?action=getTests&search=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(tests => {
            let html = "";
            tests.forEach(t => {
                html += `<div><button type="button" onclick="addSelectedTest('${t.code}','${t.name}','${t.cost}')">${t.name} - ₹${t.cost}</button></div>`;
            });
            document.getElementById("testList").innerHTML = html;
        });
}

function loadPackages(query) {
    query = (query || "").trim();
    if (query.length < 2) { document.getElementById("packageList").innerHTML = ""; return; }
    fetch(`${API_URL}?action=getPackages&search=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(packages => {
            let html = "";
            packages.forEach(p => {
                html += `<div><button type="button" onclick="addSelectedPackage('${p.code}','${p.name}','${p.cost}')">${p.name} - ₹${p.cost}</button></div>`;
            });
            document.getElementById("packageList").innerHTML = html;
        });
}

function addSelectedTest(code, name, cost) {
    if (!document.getElementById("test_" + code)) {
        let tr = document.createElement("tr");
        tr.id = "test_" + code;
        tr.innerHTML = `<td>${name}</td><td>₹${cost}</td>
            <td><button type="button" onclick="removeSelected('test_${code}')">Remove</button></td>
            <input type="hidden" class="selected-test" value="${code}|${cost}">`;
        document.getElementById("selectedTestsBody").appendChild(tr);
    }
    document.getElementById("testList").innerHTML = "";
    recalculateTotal();
}

function addSelectedPackage(code, name, cost) {
    if (!document.getElementById("package_" + code)) {
        let tr = document.createElement("tr");
        tr.id = "package_" + code;
        tr.innerHTML = `<td>${name}</td><td>₹${cost}</td>
            <td><button type="button" onclick="removeSelected('package_${code}')">Remove</button></td>
            <input type="hidden" class="selected-package" value="${code}|${cost}">`;
        document.getElementById("selectedPackagesBody").appendChild(tr);
    }
    document.getElementById("packageList").innerHTML = "";
    recalculateTotal();
}

function removeSelected(id) { document.getElementById(id).remove(); recalculateTotal(); }

function calcAge() {
    let dob = document.getElementById("dob").value;
    if (dob) {
        let birth = new Date(dob), today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        let m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
        document.getElementById("age").value = age;
    }
}

function recalculateTotal() {
    let testsCost = 0, packagesCost = 0;
    document.querySelectorAll(".selected-test").forEach(item => testsCost += parseFloat(item.value.split("|")[1]) || 0);
    document.querySelectorAll(".selected-package").forEach(item => packagesCost += parseFloat(item.value.split("|")[1]) || 0);
    let totalAmount = testsCost + packagesCost;
    document.getElementById("totalAmount").value = totalAmount.toFixed(2);
    let discountPercent = parseFloat(document.getElementById("discountList").value) || 0;
    let techCharge = parseFloat(document.getElementById("techCharge").value) || 0;
    let discountedPart = (totalAmount - packagesCost) - ((discountPercent / 100) * (totalAmount - packagesCost));
    let totalToPay = discountedPart + packagesCost + techCharge;
    document.getElementById("totalToPay").value = totalToPay.toFixed(2);
}

function searchCustomer() {
    let num = document.getElementById("custNumber").value;
    if (num.length !== 10) { alert("Enter a valid 10-digit Customer Number"); return; }
    fetch(`${API_URL}?action=searchBookings&customerNumber=${encodeURIComponent(num)}`)
        .then(res => res.json())
        .then(bookings => {
            const body = document.getElementById("historyBody");
            body.innerHTML = "";
            if (bookings.length === 0) { alert("No booking history for this number"); return; }
            document.getElementById("history").style.display = 'block';
            bookings.forEach(b => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${b.customerNumber}</td><td>${b.name}</td><td>${b.dateTime}</td>
                    <td>${b.phlebo}</td><td>${b.agent}</td><td>${b.createdDateTime || ''}</td>
                    <td><button class="small-btn edit" onclick="editBooking('${b.bookingId}')">E</button></td>
                    <td><button class="small-btn cancel" onclick="updateStatus('${b.bookingId}','Cancel')">X</button></td>
                    <td><button class="small-btn paid" onclick="updateStatus('${b.bookingId}','Paid')">P</button></td>`;
                body.appendChild(tr);
            });
        });
}

function showBookingForm() { document.getElementById("bookingForm").style.display = 'block'; }

function createBooking() {
    let params = {
        customerNumber: document.getElementById("custNumber").value.trim(),
        mainCustomerName: document.getElementById("custName").value.trim(),
        age: document.getElementById("age").value.trim(),
        gender: document.getElementById("gender").value,
        address: document.getElementById("address").value.trim(),
        location: document.getElementById("location").value.trim(),
        city: document.getElementById("city").value,
        phleboName: document.getElementById("phleboList").value,
        preferredDate: document.getElementById("prefDate").value,
        preferredTime: document.getElementById("prefTime").value
    };
    if (!params.customerNumber || params.customerNumber.length !== 10) { alert("Enter valid 10-digit customer number"); return; }
    if (!params.mainCustomerName) { alert("Enter customer name"); return; }
    if (!params.age) { alert("Enter age"); return; }
    if (!params.gender) { alert("Select gender"); return; }
    if (!params.address) { alert("Enter address"); return; }
    if (!params.location) { alert("Enter location"); return; }
    if (!params.city) { alert("Select city"); return; }
    if (!params.phleboName) { alert("Select phlebo"); return; }
    if (!params.preferredDate) { alert("Select preferred date"); return; }
    if (!params.preferredTime) { alert("Select preferred time"); return; }

    // NEW: Save to Google Sheet with status = "Submit"
    fetch(`${API_URL}?action=createBooking`, {
        method: 'POST',
        body: JSON.stringify({ ...params, status: 'Submit' }),
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(resp => {
        if (resp.success) {
            alert("Booking saved successfully!");
            freezeBookingForm();
        } else {
            alert("Error saving booking");
        }
    });
}

function freezeBookingForm() {
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea")
        .forEach(el => { el.readOnly = true; el.disabled = true; });
    document.querySelector('button[onclick="addSubBooking()"]').disabled = false;
    document.querySelector('button[onclick="confirmBooking()"]').disabled = false;
}

function addSubBooking() {
    let custNum = document.getElementById("custNumber").value;
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea").forEach(el => {
        if (el.id !== "custNumber") el.value = "";
        el.readOnly = false;
        el.disabled = false;
    });
    document.getElementById("custNumber").value = custNum;
}
</script>
</body>
</html>
