<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Booking</title>
<link rel="stylesheet" href="style.css">
<script src="script.js"></script>
<style>
.small-btn { padding: 5px 10px; font-size: 12px; border-radius: 50%; border: none; cursor: pointer; }
.cancel { background: red; color: white; }
.edit { background: orange; color: white; }
.paid { background: green; color: white; }
.flex { display: flex; gap: 10px; flex-wrap: wrap; }
.flex input, .flex select { flex: 1; }
</style>
</head>
<body>
<button class="nav-btn back" onclick="goBack()">Back</button>
<button class="nav-btn home" onclick="goHome()">Home</button>
<div class="container">
<h2>Booking Form</h2>

<!-- Search Section -->
<div class="flex">
    <input type="number" id="custNumber" placeholder="Customer Number (10 digits)" maxlength="10" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)">
    <button onclick="searchCustomer()">Search</button>
    <button onclick="showBookingForm()">Create Booking</button>
</div>

<!-- Booking History -->
<div id="history" style="display:none;">
    <h3>Booking History</h3>
    <div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Customer Number</th>
                <th>Customer Name</th>
                <th>Preferred Date & Time</th>
                <th>Technician Name</th>
                <th>Agent Name</th>
                <th>Created Date & Time</th>
                <th>Edit</th>
                <th>Cancel</th>
                <th>Paid</th>
            </tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
    </div>
</div>

<!-- Booking Form Fields -->
<div id="bookingForm" style="display:none;">
    <h3>New Booking</h3>
    <input type="text" id="custName" placeholder="Main Customer Name" required>
    <input type="date" id="dob" placeholder="Date of Birth" onchange="calcAge()">
    <input type="number" id="age" placeholder="Age" required>
    <select id="gender">
        <option>Male</option>
        <option>Female</option>
    </select>
    <textarea id="address" placeholder="Address" maxlength="500" required></textarea>
    <input type="text" id="location" placeholder="Location" maxlength="100" required>
    <select id="city">
        <option>Chennai</option>
        <option>Bangalore</option>
        <option>Hyderabad</option>
        <option>Mumbai</option>
        <option>Delhi</option>
        <option>Coimbatore</option>
    </select>
    <select id="phleboList" onchange="checkPhleboAvailability()">
        <option value="">--Select Phlebo--</option>
    </select>
    <input type="number" id="pincode" placeholder="Pincode (6 digits)" maxlength="6">
    <input type="date" id="prefDate" min="" onchange="checkPhleboAvailability()">
    <select id="prefTime" onchange="checkPhleboAvailability()"></select>

    <!-- Test selection -->
    <label>Tests</label>
    <input type="text" placeholder="Search Test" oninput="loadTests(this.value)">
    <div id="testList"></div>
    <div id="selectedTests">
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr>
                    <th>Test Name</th>
                    <th>Cost</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="selectedTestsBody"></tbody>
        </table>
    </div>

    <!-- Package selection -->
    <label>Packages</label>
    <input type="text" placeholder="Search Package" oninput="loadPackages(this.value)">
    <div id="packageList"></div>
    <div id="selectedPackages">
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr>
                    <th>Package Name</th>
                    <th>Cost</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="selectedPackagesBody"></tbody>
        </table>
    </div>

    <input type="number" id="totalAmount" placeholder="Total Amount" readonly>

    <!-- Discount changed to percentage -->
    <select id="discountList" onchange="recalculateTotal()">
        <option value="">Select Discount</option>
        <option value="0">No Discount</option>
        <option value="5">5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20">20%</option>
    </select>

    <input type="number" id="techCharge" placeholder="Technician Charge" oninput="recalculateTotal()">
    <input type="number" id="totalToPay" placeholder="Total Amount to be Paid" readonly>

    <button onclick="createBooking()">Submit</button>
    <button onclick="addSubBooking()">Sub Booking</button>
    <button onclick="confirmBooking()">Confirm Booking</button>
</div>
</div>

<script>
window.onload = function() {
    let today = new Date().toISOString().split("T")[0];
    document.getElementById("prefDate").setAttribute("min", today);

    let timeSelect = document.getElementById('prefTime');
    let startHour = 6, endHour = 18;
    for (let h = startHour; h < endHour; h++) {
        let times = [`${h}:00`, `${h}:30`];
        for (let i = 0; i < times.length; i++) {
            let nextH = h + (i === 0 ? 0 : 1);
            let nextM = (i === 0 ? ":30" : ":00");
            let display = `${times[i]} - ${nextH}${nextM}`;
            let opt = document.createElement("option");
            opt.text = display;
            timeSelect.add(opt);
        }
    }
    loadPhlebos();
};

function searchCustomer() {
    let num = document.getElementById("custNumber").value;
    if (num.length !== 10) {
        alert("Enter a valid 10-digit Customer Number");
        return;
    }
    fetch(`${API_URL}?action=searchBookings&customerNumber=${encodeURIComponent(num)}`)
        .then(res => res.json())
        .then(bookings => {
            const body = document.getElementById("historyBody");
            body.innerHTML = "";
            if (bookings.length === 0) {
                alert("No booking history for this number");
                return;
            }
            document.getElementById("history").style.display = 'block';
            bookings.forEach(b => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${b.customerNumber}</td>
                    <td>${b.name}</td>
                    <td>${b.dateTime}</td>
                    <td>${b.phlebo}</td>
                    <td>${b.agent}</td>
                    <td>${b.createdOn || ''}</td>
                    <td><button class="small-btn edit" onclick="editBooking('${b.bookingId}')">E</button></td>
                    <td><button class="small-btn cancel" onclick="updateStatus('${b.bookingId}','Cancel')">X</button></td>
                    <td><button class="small-btn paid" onclick="updateStatus('${b.bookingId}','Paid')">P</button></td>
                `;
                body.appendChild(tr);
            });
        });
}

function showBookingForm() {
    let num = document.getElementById("custNumber").value.trim();
    if (num.length !== 10) {
        alert("Please enter a valid 10-digit Customer Number before creating a booking");
        return;
    }
    document.getElementById("bookingForm").style.display = 'block';
}

function createBooking() {
    let hasTests = document.querySelectorAll(".selected-test").length > 0;
    let hasPackages = document.querySelectorAll(".selected-package").length > 0;

    let params = {
        customerNumber: document.getElementById("custNumber").value.trim(),
        mainCustomerName: document.getElementById("custName").value.trim(),
        age: document.getElementById("age").value.trim(),
        gender: document.getElementById("gender").value,
        address: document.getElementById("address").value.trim(),
        location: document.getElementById("location").value.trim(),
        city: document.getElementById("city").value,
        phleboName: document.getElementById("phleboList").value,
        pincode: document.getElementById("pincode").value.trim(),
        preferredDate: document.getElementById("prefDate").value,
        preferredTime: document.getElementById("prefTime").value,
        discount: document.getElementById("discountList").value,
        techCharge: document.getElementById("techCharge").value
    };

    if (params.customerNumber.length !== 10) return alert("Enter valid 10-digit customer number");
    if (!params.mainCustomerName) return alert("Enter customer name");
    if (!params.age) return alert("Enter age");
    if (!params.gender) return alert("Select gender");
    if (!params.address) return alert("Enter address");
    if (!params.location) return alert("Enter location");
    if (!params.city) return alert("Select city");
    if (!params.phleboName) return alert("Select phlebo");
    if (!params.pincode) return alert("Enter pincode");
    if (!params.preferredDate || !params.preferredTime) return alert("Select preferred date and time");
    if (!hasTests && !hasPackages) return alert("Select at least one test or one package");
    if (params.discount === "") return alert("Select discount");
    if (params.techCharge === "") return alert("Enter technician charge");

    saveBooking(); 
}

function addSubBooking() {
    let custNum = document.getElementById("custNumber").value.trim();
    if (custNum.length !== 10) {
        alert("Enter a valid 10-digit Customer Number first");
        return;
    }
    fetch(`${API_URL}?action=getMainBooking&customerNumber=${custNum}`)
    .then(res => res.json())
    .then(mainBooking => {
        if (!mainBooking) {
            alert("Main booking not found");
            return;
        }
        document.getElementById("address").value = mainBooking.address;
        document.getElementById("location").value = mainBooking.location;
        document.getElementById("city").value = mainBooking.city;
        document.getElementById("phleboList").value = mainBooking.phlebo;
        document.getElementById("pincode").value = mainBooking.pincode;
        document.getElementById("prefDate").value = mainBooking.prefDate;
        document.getElementById("prefTime").value = mainBooking.prefTime;

        ["address","location","city","phleboList","pincode","prefDate","prefTime"].forEach(id => {
            document.getElementById(id).disabled = true;
        });
    });
}

function confirmBooking() {
    let custNum = document.getElementById("custNumber").value.trim();
    if (!custNum) {
        alert("No booking to confirm");
        return;
    }
    fetch(`${API_URL}?action=confirmBooking&customerNumber=${custNum}`)
    .then(res => res.json())
    .then(res => {
        if (res.success) {
            alert("Booking confirmed successfully");
            document.getElementById("bookingForm").reset();
            document.getElementById("bookingForm").style.display = "none";
        }
    });
}
</script>
</body>
</html>
