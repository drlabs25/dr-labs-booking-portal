<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Booking</title>
<link rel="stylesheet" href="style.css">
<script src="script.js"></script>
<style>
    .summary-panel{
  position: fixed;
  top: 90px;        /* below your header */
  left: 20px;
  width: 280px;
  max-height: 70vh;
  overflow:auto;
  background:#f7fbff;
  border:1px solid #cfe2ff;
  border-radius:8px;
  padding:10px 12px;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
  z-index: 998;     /* below your top-left nav (999) */
}
.summary-panel table td{ padding:6px 0; }
.summary-panel td:last-child{ text-align:right; }

.small-btn { padding: 5px 10px; font-size: 12px; border-radius: 50%; border: none; cursor: pointer; }
.cancel { background: red; color: white; }
.edit { background: orange; color: white; }
.paid { background: green; color: white; }
.flex { display: flex; gap: 10px; flex-wrap: wrap; }
.flex input, .flex select { flex: 1; }

/* Container for top-left buttons */
#topLeftBtns {
    position: fixed;
    top: 10px;
    left: 20px;
    display: flex;
    gap: 6px;   /* space between buttons */
    z-index: 999;
}

/* Style for both Back & Home buttons */
#topLeftBtns button {
    padding: 4px 8px;      
    font-size: 11px;       
    border-radius: 4px;    
    border: 1px solid #007bff;
    background: #e6f0ff;   
    color: #007bff;        
    cursor: pointer;
}

#topLeftBtns button:hover {
    background: #cce0ff;   /* hover effect */
}
</style>
</head>
<body>
    <header>
  <div style="position:fixed; top:10px; right:20px; text-align:right;">
      <div><strong id="agentNameLabel"></strong></div>
      <div><small id="dateTimeLabel"></small></div>
  </div>
</header>

<div id="topLeftBtns">
  <button id="backBtn" onclick="goBack()">‚¨Ö Back</button>
  <button id="homeBtn" onclick="goHome()">üè† Home</button>
</div>
<div class="container">
<h2>Booking Form</h2>

<!-- Search Section -->
<div class="flex">
    <input type="number" id="searchCustNumber" placeholder="Customer Number (10 digits)" maxlength="10" oninput="validateCustomerNumber(this)">
<button onclick="searchCustomer()">Search</button>
<button id="createBookingBtn" onclick="showBookingForm()" disabled>Create Booking</button>
  
</div>
<!-- Booking History -->
<div id="history" style="display:none;">
    <h3>Booking History</h3>
    <div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Customer Number</th>
                <th>Customer Name</th>
                <th>Preferred Date & Time</th>
                <th>Technician Name</th>
                <th>Created Date & Time</th>
                <th>Agent Name</th>
                <th>Status</th>
                <th>Edit</th>
                <th>Cancel</th>
                <th>Paid</th>
            </tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
    </div>
</div>

<!-- LEFT SUMMARY: Pending bookings -->
<div id="bookingSummary" class="summary-panel" style="display:none;">
  <h3 style="margin:0 0 8px;">Pending Bookings</h3>
  <div style="font-size:12px;color:#666;margin-bottom:6px;">(Review before confirming)</div>

  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th style="text-align:left; border-bottom:1px solid #ddd;">Customer</th>
        <th style="text-align:right; border-bottom:1px solid #ddd;">Cost</th>
      </tr>
    </thead>
    <tbody id="bookingSummaryBody"></tbody>
  </table>

  <div style="margin-top:8px; padding-top:8px; border-top:1px solid #eee; display:flex; justify-content:space-between;">
    <strong>Total</strong>
    <strong>‚Çπ<span id="bookingSummaryGrand">0.00</span></strong>
  </div>
</div>


<!-- Booking Form Fields -->
<div id="bookingForm" style="display:none; margin-top:20px;">

    <!-- Customer Information -->
    <fieldset style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:6px;">
        <legend><b>Customer Information</b></legend>
        <div class="flex">
            <input type="text" id="custNumber" placeholder="Customer Number (10 digits)" maxlength="10" required>
            <input type="text" id="custName" placeholder="Customer Name" required>
            <input type="date" id="dob" placeholder="Date of Birth" onchange="calcAge()">
            <input type="number" id="age" placeholder="Age" required>
            <select id="gender" required>
                <option value="">--Gender--</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
        </div>
        <div class="flex">
            <textarea id="address" placeholder="Address" maxlength="500" required></textarea>
            <input type="text" id="location" placeholder="Location" maxlength="100" required>
            <select id="city" required>
                <option value="">--Select City--</option>
                <option>Chennai</option>
                <option>Bangalore</option>
                <option>Hyderabad</option>
                <option>Mumbai</option>
                <option>Delhi</option>
                <option>Coimbatore</option>
            </select>
            <input type="number" id="pincode" placeholder="Pincode (6 digits)" maxlength="6" required>
        </div>
    </fieldset>

    <!-- Assigning Information -->
    <fieldset style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:6px;">
        <legend><b>Assigning Information</b></legend>
        <div class="flex">
            <select id="phleboList" onchange="checkPhleboAvailability()" required>
                <option value="">--Select Phlebo--</option>
            </select>
            <input type="date" id="prefDate" min="" onchange="checkPhleboAvailability()" required>
            <select id="prefTime" onchange="checkPhleboAvailability()" required></select>
        </div>
    </fieldset>

    <!-- Test, Package & Amount Details -->
    <fieldset style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:6px;">
        <legend><b>Test, Package & Amount Details</b></legend>
        
        <!-- Tests -->
        <label>Tests</label>
        <input type="text" placeholder="Search Test" oninput="loadTests(this.value)">
        <div id="testList"></div>
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr><th>Test Name</th><th>Cost</th><th>Action</th></tr>
            </thead>
            <tbody id="selectedTestsBody"></tbody>
        </table>

        <!-- Packages -->
        <label>Packages</label>
        <input type="text" placeholder="Search Package" oninput="loadPackages(this.value)">
        <div id="packageList"></div>
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr><th>Package Name</th><th>Cost</th><th>Action</th></tr>
            </thead>
            <tbody id="selectedPackagesBody"></tbody>
        </table>

        <!-- Amounts -->
        <div class="flex">
            <input type="number" id="totalAmount" placeholder="Total Amount" readonly>
            <select id="discountList" onchange="recalculateTotal()">
                <option value="0">No Discount</option>
                <option value="5">5%</option>
                <option value="10">10%</option>
                <option value="15">15%</option>
                <option value="20">20%</option>
            </select>
            <input type="number" id="techCharge" placeholder="Technician Charge" oninput="recalculateTotal()">
            <input type="number" id="totalToPay" placeholder="Total To Pay" readonly>
            <div class="flex">
<input type="number" id="grandTotalToPay" placeholder="Total Amount To Be Paid (All Bookings)" readonly style="display:none;">

</div>

            
    </fieldset>

    <!-- Submit -->

<button type="button" id="submitBtn" onclick="createBooking()">Submit</button>
<button type="button" id="updateBtn" onclick="updateBookingFromForm()" style="display:none;">Update</button>
</div>
<div id="bookingForm" style="display:none;">
    <h3>New Booking</h3>
    <!-- Hidden bookingId for edit mode -->
    <input type="hidden" id="bookingId">
    <!-- ‚úÖ Customer Number belongs here -->
    <input 
  type="text" 
  id="custNumber" 
  placeholder="Enter 10-digit number" 
  maxlength="10" 
  inputmode="numeric" 
  pattern="\d{10}" 
  required
>
    <input type="text" id="custName" placeholder="Main Customer Name" required>
    <input type="date" id="dob" placeholder="Date of Birth" onchange="calcAge()">
    <input type="number" id="age" placeholder="Age" required>
    <select id="gender" required>
    <option value="">--Select Gender--</option>
    <option value="Male">Male</option>
    <option value="Female">Female</option>

    </select>
    <textarea id="address" placeholder="Address" maxlength="500" required></textarea>
    <input type="text" id="location" placeholder="Location" maxlength="100" required>
    <select id="city">
        <option value="">--Select City--</option>
        <option>Chennai</option>
        <option>Bangalore</option>
        <option>Hyderabad</option>
        <option>Mumbai</option>
        <option>Delhi</option>
        <option>Coimbatore</option>
    </select>
    <select id="phleboList" onchange="checkPhleboAvailability()">
        <option value="">--Select Phlebo--</option>
    </select>
    <input type="number" id="pincode" placeholder="Pincode (6 digits)" maxlength="6" required>
    <input type="date" id="prefDate" min="" onchange="checkPhleboAvailability()">
    <select id="prefTime" onchange="checkPhleboAvailability()"></select>

    <!-- Test selection -->
    <label>Tests</label>
    <input type="text" placeholder="Search Test" oninput="loadTests(this.value)">
    <div id="testList"></div>
    <div id="selectedTests">
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr>
                    <th>Test Name</th>
                    <th>Cost</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="selectedTestsBody"></tbody>
        </table>
    </div>

    <!-- Main Booking Preview Table -->
    <div id="mainBookingPreview" style="display:none; float:right; width:35%; margin-top:20px;">
        <h3>Main Booking</h3>
        <table border="1" style="width:100%;">
            <thead>
                <tr>
                    <th>Customer Name</th>
                    <th>Preferred Date & Time</th>
                    <th>Total Cost</th>
                </tr>
            </thead>
            <tbody id="mainBookingPreviewBody"></tbody>
        </table>
    </div>

    <!-- Package selection -->
    <label>Packages</label>
    <input type="text" placeholder="Search Package" oninput="loadPackages(this.value)">
    <div id="packageList"></div>
    <div id="selectedPackages">
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr>
                    <th>Package Name</th>
                    <th>Cost</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="selectedPackagesBody"></tbody>
        </table>
    </div>

   

    <!-- ‚úÖ Only one pair of buttons -->
    <button type="button" onclick="createBooking()">Submit</button>
</div>

<!-- ‚úÖ Add More button OUTSIDE bookingForm -->
<button type="button" id="addMoreBtn" style="display:none; margin-top:10px;" onclick="addSubBooking()">Add More</button>
<button type="button" id="confirmBtn" style="display:none; margin-top:10px;" onclick="confirmBooking()">Confirm Booking</button>


<script>
window.onload = function() {
    let today = new Date().toISOString().split("T")[0];
    document.getElementById("prefDate").setAttribute("min", today);

    let timeSelect = document.getElementById('prefTime');
    let startHour = 6, endHour = 18;
    for (let h = startHour; h < endHour; h++) {
        let times = [`${h}:00`, `${h}:30`];
        for (let i = 0; i < times.length; i++) {
            let nextH = h + (i === 0 ? 0 : 1);
            let nextM = (i === 0 ? ":30" : ":00");
            let display = `${times[i]} - ${nextH}${nextM}`;
            let opt = document.createElement("option");
            opt.text = display;
            timeSelect.add(opt);
        }
    }
    loadPhlebos();
};

function validateCustomerNumber(input) {
    input.value = input.value.replace(/[^0-9]/g, '');
    document.getElementById("createBookingBtn").disabled = (input.value.length !== 10);
}

function validateAndShowBookingForm() {
    let num = document.getElementById("custNumber").value.trim();

    // Check for exactly 10 numeric digits
    if (num.length !== 10 || !/^\d+$/.test(num)) {
        alert("Please enter a valid 10-digit Customer Number");
        return;
    }

    // Clear form inputs except the customer number
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea").forEach(el => {
        if (el.id !== "custNumber") el.value = "";
    });

    // ‚úÖ Show the booking form
    document.getElementById("bookingForm").style.display = "block";

    // Hide booking history if it‚Äôs visible
    document.getElementById("history").style.display = "none";
}

function showBookingForm() {
    let num = document.getElementById("searchCustNumber").value.trim();

    // Validate customer number
    if (num.length !== 10 || !/^\d+$/.test(num)) {
        alert("Please enter a valid 10-digit Customer Number");
        return;
    }

    // Put number into the booking form‚Äôs custNumber field
    document.getElementById("custNumber").value = num;
    document.getElementById("custNumber").readOnly = true; // freeze it

    // Reset other fields except custNumber + bookingId
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea").forEach(el => {
        if (el.id !== "custNumber" && el.id !== "bookingId") el.value = "";
    });

    // Reset tables + totals
    document.getElementById("selectedTestsBody").innerHTML = "";
    document.getElementById("selectedPackagesBody").innerHTML = "";
    document.getElementById("totalAmount").value = "";
    document.getElementById("techCharge").value = "";
    document.getElementById("totalToPay").value = "";
    document.getElementById("discountList").value = "0";

    // Switch buttons for new booking
    document.getElementById("submitBtn").style.display = "inline-block";
    document.getElementById("updateBtn").style.display = "none";

    // ‚úÖ Unfreeze fields in new booking mode
    document.getElementById("location").disabled   = false;
    document.getElementById("city").disabled       = false;
    document.getElementById("pincode").disabled    = false;
    document.getElementById("phleboList").disabled = false;
    document.getElementById("prefDate").disabled   = false;
    document.getElementById("prefTime").disabled   = false;

    // ‚úÖ Finally show the form
    document.getElementById("bookingForm").style.display = "block";
    document.getElementById("history").style.display = "none";
}


function loadTests(query) {
    query = (query || "").trim();
    if (query.length < 2) {
        document.getElementById("testList").innerHTML = "";
        return;
    }
    fetch(`${API_URL}?action=getTests&search=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(tests => {
            let html = "";
            tests.forEach(t => {
                html += `<div><button type="button" onclick="addSelectedTest('${t.code}','${t.name}','${t.cost}')">${t.name} - ‚Çπ${t.cost}</button></div>`;
            });
            document.getElementById("testList").innerHTML = html;
        });
}

function loadPackages(query) {
    query = (query || "").trim();
    if (query.length < 2) {
        document.getElementById("packageList").innerHTML = "";
        return;
    }
    fetch(`${API_URL}?action=getPackages&search=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(packages => {
            let html = "";
            packages.forEach(p => {
                html += `<div><button type="button" onclick="addSelectedPackage('${p.code}','${p.name}','${p.cost}')">${p.name} - ‚Çπ${p.cost}</button></div>`;
            });
            document.getElementById("packageList").innerHTML = html;
        });
}

function addSelectedTest(code, name, cost) {
    if (!document.getElementById("test_" + code)) {
        let tr = document.createElement("tr");
        tr.id = "test_" + code;
        tr.innerHTML = `
            <td>${name}</td>
            <td>‚Çπ${cost}</td>
            <td><button type="button" onclick="removeSelected('test_${code}')">Remove</button></td>
            <input type="hidden" class="selected-test" value="${code}|${cost}">
        `;
        document.getElementById("selectedTestsBody").appendChild(tr);
    }
    document.getElementById("testList").innerHTML = "";
    recalculateTotal();
}

function addSelectedPackage(code, name, cost) {
    if (!document.getElementById("package_" + code)) {
        let tr = document.createElement("tr");
        tr.id = "package_" + code;
        tr.innerHTML = `
            <td>${name}</td>
            <td>‚Çπ${cost}</td>
            <td><button type="button" onclick="removeSelected('package_${code}')">Remove</button></td>
            <input type="hidden" class="selected-package" value="${code}|${cost}">
        `;
        document.getElementById("selectedPackagesBody").appendChild(tr);
    }
    document.getElementById("packageList").innerHTML = "";
    recalculateTotal();
}

function removeSelected(id) {
    document.getElementById(id).remove();
    recalculateTotal();
}

function calcAge() {
    let dob = document.getElementById("dob").value;
    if (dob) {
        let birth = new Date(dob);
        let today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        let m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        document.getElementById("age").value = age;
    }
}

function recalculateTotal() {
    let testsCost = 0;
    document.querySelectorAll(".selected-test").forEach(item => {
        testsCost += parseFloat(item.value.split("|")[1]) || 0;
    });

    let packagesCost = 0;
    document.querySelectorAll(".selected-package").forEach(item => {
        packagesCost += parseFloat(item.value.split("|")[1]) || 0;
    });

    let totalAmount = testsCost + packagesCost;
    document.getElementById("totalAmount").value = totalAmount.toFixed(2);

    let discountPercent = parseFloat(document.getElementById("discountList").value) || 0;
    let techCharge = parseFloat(document.getElementById("techCharge").value) || 0;

    let discountedPart = (totalAmount - packagesCost) - ((discountPercent / 100) * (totalAmount - packagesCost));
    let totalToPay = discountedPart + packagesCost + techCharge;

    document.getElementById("totalToPay").value = totalToPay.toFixed(2);
}

function searchCustomer() {
    let num = document.getElementById("searchCustNumber").value.trim();
    if (num.length !== 10) {
        alert("Enter a valid 10-digit Customer Number");
        return;
    }
    fetch(`${API_URL}?action=searchBookings&customerNumber=${encodeURIComponent(num)}`)
        .then(res => res.json())
        .then(bookings => {
            const body = document.getElementById("historyBody");
            body.innerHTML = "";
            if (bookings.length === 0) {
                alert("No booking history for this number");
                return;
            }
            document.getElementById("history").style.display = 'block';
            bookings.forEach(b => {
                const tr = document.createElement("tr");

                if (b.status && b.status.toLowerCase() === "paid") {
                    tr.style.backgroundColor = "lightgreen";
                } else if (b.status && b.status.toLowerCase() === "cancel") {
                    tr.style.backgroundColor = "lightcoral";
                    tr.style.color = "white";
                } else if (b.status && b.status.toLowerCase() === "confirm") {
                    tr.style.backgroundColor = "lightblue";
                }

             let disabled = (b.status && ["cancel","paid"].includes(b.status.toLowerCase())) ? "disabled" : "";

tr.innerHTML = `
    <td>${b.customerNumber}</td>
    <td>${b.name}</td>
    <td>${b.dateTime}</td>
    <td>${b.phlebo}</td>
    <td>${b.createdDateTime}</td>
    <td>${b.agent}</td>
    <td>${b.status || ''}</td>
    <td><button class="small-btn edit" onclick="editBooking('${b.bookingId}')" ${disabled}>E</button></td>
    <td><button class="small-btn cancel" onclick="updateStatus('${b.bookingId}','Cancel')" ${disabled}>X</button></td>
    <td><button class="small-btn paid" onclick="updateStatus('${b.bookingId}','Paid')" ${disabled}>P</button></td>
`;

                body.appendChild(tr);
            });
        });
}

// ‚úÖ Updated: Instant color change when status updates
function updateStatus(bookingId, status) {
    if (!confirm(`Are you sure you want to mark this booking as ${status}?`)) return;

    fetch(`${API_URL}?action=updateBookingStatus&bookingId=${encodeURIComponent(bookingId)}&status=${encodeURIComponent(status)}&t=${Date.now()}`)
        .then(res => res.json())
        .then(data => {
            console.log("Update Status Response:", data);
            if (data.success) {
                alert(`Booking marked as ${status}`);

                let row = [...document.querySelectorAll("#historyBody tr")]
                    .find(tr => tr.innerHTML.includes(bookingId));

                if (row) {
                    let statusCell = row.querySelector("td:nth-child(7)");
                    if (statusCell) statusCell.textContent = status;

                    if (status.toLowerCase() === "paid") {
                        row.style.backgroundColor = "lightgreen";
                        row.style.color = "";
                    } else if (status.toLowerCase() === "cancel") {
                        row.style.backgroundColor = "lightcoral";
                        row.style.color = "white";
                    } else if (status.toLowerCase() === "confirm") {
                        row.style.backgroundColor = "lightblue";
                        row.style.color = "";
                    }
                }
            } else {
                alert("Failed to update status: " + (data.message || "Unknown error"));
            }
        })
        .catch(err => {
            console.error("Error updating status:", err);
            alert("Error updating status. Check console for details.");
        });
}

function createBooking() {
    // Reset all borders first
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea")
        .forEach(el => el.style.border = "");

    let isValid = true;
    function markInvalid(id) {
        document.getElementById(id).style.border = "2px solid red";
        isValid = false;
    }

    let custNumber = document.getElementById("custNumber").value.trim();
    if (custNumber.length !== 10 || !/^\d+$/.test(custNumber)) markInvalid("custNumber");

    if (!document.getElementById("custName").value.trim()) markInvalid("custName");
    if (!document.getElementById("age").value.trim()) markInvalid("age");
    if (!document.getElementById("gender").value) markInvalid("gender");
    if (!document.getElementById("address").value.trim()) markInvalid("address");
    if (!document.getElementById("location").value.trim()) markInvalid("location");
    if (!document.getElementById("city").value) markInvalid("city");
    if (!document.getElementById("phleboList").value) markInvalid("phleboList");

    let pincode = document.getElementById("pincode").value.trim();
    if (pincode.length !== 6 || !/^\d+$/.test(pincode)) markInvalid("pincode");

    if (!document.getElementById("prefDate").value) markInvalid("prefDate");
    if (!document.getElementById("prefTime").value) markInvalid("prefTime");

    let tests = getSelectedTests();
    let packages = getSelectedPackages();
    if (!tests && !packages) {
        document.querySelector("#testList")?.style.setProperty("border", "2px solid red", "important");
        document.querySelector("#packageList")?.style.setProperty("border", "2px solid red", "important");
        isValid = false;
    }

    if (!document.getElementById("discountList").value) markInvalid("discountList");
    if (!document.getElementById("techCharge").value.trim()) markInvalid("techCharge");

    if (!isValid) {
        alert("Please fill all required fields.");
        return;
    }

    // ‚úÖ Always generate NEW bookingId (avoid overwrite)
    let newBookingId = "BKG_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

    let params = new URLSearchParams({
        action: "saveBooking",
        bookingId: newBookingId,
        customerNumber: custNumber,
        mainCustomerName: document.getElementById("custName").value.trim(),
        dob: document.getElementById("dob").value,
        age: document.getElementById("age").value.trim(),
        gender: document.getElementById("gender").value,
        address: document.getElementById("address").value.trim(),
        location: document.getElementById("location").value.trim(),
        city: document.getElementById("city").value,
        phleboName: document.getElementById("phleboList").value,
        pincode: pincode,
        preferredDate: document.getElementById("prefDate").value,
        preferredTime: document.getElementById("prefTime").value,
        tests: tests,
        packages: packages,
        totalAmount: document.getElementById("totalAmount").value,
        discount: document.getElementById("discountList").value,
        techCharge: document.getElementById("techCharge").value,
        totalToPay: document.getElementById("totalToPay").value,
        agentName: localStorage.getItem("agentName") || "",
    });

    fetch(`${API_URL}?${params.toString()}`)
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById("bookingId").value = newBookingId;

            // Decide label (Main or Sub Booking)
            let label;
            if (bookingList.length === 0) {
                label = "Main Booking";
            } else {
                subBookingCounter++;
                label = `Sub Booking ${subBookingCounter}`;
            }

            // Push into bookingList
            bookingList.push({
                type: label,
                name: document.getElementById("custName").value.trim(),
                datetime: `${document.getElementById("prefDate").value} ${document.getElementById("prefTime").value}`,
                  cost: parseFloat(document.getElementById("totalToPay").value) || 0
            });

           // Render the table
renderBookingTable();
renderPendingSummary();   // ‚¨ÖÔ∏è add this single line

// Hide booking form after submit
document.getElementById("bookingForm").style.display = "none";


            // Show buttons
            document.getElementById("addMoreBtn").style.display = "inline-block";
            document.getElementById("confirmBtn").style.display = "inline-block";

            alert(label + " saved! ID: " + newBookingId);
        } else {
            alert("Failed to save booking.");
        }
    })
    .catch(err => {
        console.error("Booking save error:", err);
        alert("Something went wrong while saving booking!");
    });
}

// Render all bookings into the table
function renderBookingTable() {
    const body = document.getElementById("mainBookingPreviewBody");
    body.innerHTML = "";
    bookingList.forEach(b => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${b.type}: ${b.name}</td>
            <td>${b.datetime}</td>
            <td>‚Çπ${b.cost}</td>
        `;
        body.appendChild(tr);
    });
    document.getElementById("mainBookingPreview").style.display = "block";
}



function editBooking(bookingId) {
    fetch(`${API_URL}?action=getBookingDetails&bookingId=${bookingId}`)
        .then(res => res.json())
        .then(data => {
            if (!data || data.success === false) {
                alert("Booking not found");
                return;
            }

            // Fill form fields
            document.getElementById("bookingId").value   = bookingId;
            document.getElementById("custNumber").value  = data.customerNumber || "";
            document.getElementById("custName").value    = data.mainCustomerName || "";
            document.getElementById("dob").value         = data.dob || "";
            document.getElementById("age").value         = data.age || "";
            document.getElementById("gender").value      = data.gender || "";
            document.getElementById("address").value     = data.address || "";
            document.getElementById("location").value    = data.location || "";
            document.getElementById("city").value        = data.city || "";
            document.getElementById("phleboList").value  = data.phleboName || "";
            document.getElementById("pincode").value     = data.pincode || "";
            document.getElementById("prefDate").value    = data.preferredDate || "";
            document.getElementById("prefTime").value    = data.preferredTime || "";
            document.getElementById("totalAmount").value = data.totalAmount || "";
            document.getElementById("discountList").value= data.discount || "0";
            document.getElementById("techCharge").value  = data.techCharge || "";
            document.getElementById("totalToPay").value  = data.totalToPay || "";

            // ‚úÖ Restore Tests
            document.getElementById("selectedTestsBody").innerHTML = "";
            if (data.tests) {
                data.tests.split(",").forEach(item => {
                    const parts = item.split("|");
                    if (parts.length >= 3) {
                        const code = parts[0];
                        const cost = parts[1];
                        const name = parts[2];
                        addSelectedTest(code, name, cost);
                    }
                });
            }

            // ‚úÖ Restore Packages
            document.getElementById("selectedPackagesBody").innerHTML = "";
            if (data.packages) {
                data.packages.split(",").forEach(item => {
                    const parts = item.split("|");
                    if (parts.length >= 3) {
                        const code = parts[0];
                        const cost = parts[1];
                        const name = parts[2];
                        addSelectedPackage(code, name, cost);
                    }
                });
            }

            // ‚úÖ Refresh totals
            recalculateTotal();

            // Switch buttons
            document.getElementById("submitBtn").style.display = "none";
            document.getElementById("updateBtn").style.display = "inline-block";

            // Freeze these fields in edit mode
            document.getElementById("location").disabled   = true;
            document.getElementById("city").disabled       = true;
            document.getElementById("pincode").disabled    = true;
            document.getElementById("phleboList").disabled = true;
            document.getElementById("prefDate").disabled   = true;
            document.getElementById("prefTime").disabled   = true;

            // Show form, hide history
            document.getElementById("bookingForm").style.display = "block";
            document.getElementById("history").style.display = "none";
        })
        .catch(err => {
            console.error("Error fetching booking details:", err);
            alert("Error fetching booking details!");
        });
}





function updateBookingFromForm() {
    let bookingId = document.getElementById("bookingId").value;
    if (!bookingId) {
        alert("No booking selected for update!");
        return;
    }

    let params = new URLSearchParams({
        action: "updateBooking",
        bookingId: bookingId,  // use existing ID
        customerNumber: document.getElementById("custNumber").value.trim(),
        mainCustomerName: document.getElementById("custName").value.trim(),
        dob: document.getElementById("dob").value,
        age: document.getElementById("age").value.trim(),
        gender: document.getElementById("gender").value,
        address: document.getElementById("address").value.trim(),
        location: document.getElementById("location").value.trim(),
        city: document.getElementById("city").value,
        phleboName: document.getElementById("phleboList").value,
        pincode: document.getElementById("pincode").value.trim(),
        preferredDate: document.getElementById("prefDate").value,
        preferredTime: document.getElementById("prefTime").value,
        tests: getSelectedTests(),
        packages: getSelectedPackages(),
        totalAmount: document.getElementById("totalAmount").value,
        discount: document.getElementById("discountList").value,
        techCharge: document.getElementById("techCharge").value,
        totalToPay: document.getElementById("totalToPay").value,
        agentName: localStorage.getItem("agentName") || ""
    });

    fetch(`${API_URL}?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Booking updated successfully!");

                // ‚úÖ Switch buttons back
                document.getElementById("submitBtn").style.display = "inline-block";
                document.getElementById("updateBtn").style.display = "none";

                // ‚úÖ Hide form and refresh history table
                document.getElementById("bookingForm").style.display = "none";
                searchCustomer();
            } else {
                alert("Failed to update booking.");
            }
        })
        .catch(err => {
            console.error("Update error:", err);
            alert("Error updating booking!");
        });
}


function getSelectedTests() {
    let tests = [];
    document.querySelectorAll(".selected-test").forEach(item => {
        tests.push(item.value);
    });
    return tests.join(",");
}

function getSelectedPackages() {
    let packages = [];
    document.querySelectorAll(".selected-package").forEach(item => {
        packages.push(item.value);
    });
    return packages.join(",");
}

function loadPhlebos() {
    fetch(`${API_URL}?action=getPhlebos`)
        .then(res => res.json())
        .then(phlebos => {
            let phleboSelect = document.getElementById("phleboList");
            phlebos.forEach(phlebo => {
                let opt = document.createElement("option");
                opt.value = phlebo.name;
                opt.textContent = phlebo.name;
                phleboSelect.appendChild(opt);
            });
        });
}

function checkPhleboAvailability() {
    let phlebo = document.getElementById("phleboList").value;
    let date = document.getElementById("prefDate").value;
    let time = document.getElementById("prefTime").value;
    let bookingId = document.getElementById("bookingId").value; // added

    if (!phlebo || !date || !time) return;

    fetch(`${API_URL}?action=checkAvailability&phlebo=${encodeURIComponent(phlebo)}&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}&bookingId=${encodeURIComponent(bookingId)}`)
        .then(res => res.json())
        .then(data => {
            if (!data.available) {
                alert("Preferred time not available for this technician. Please choose another time.");
            }
        });
}
    function addMoreBooking() {
    // Reset the form
    document.getElementById("bookingForm").reset();

    // Clear hidden bookingId (new booking, not update)
    document.getElementById("bookingId").value = "";

    // Show the booking form again
    document.getElementById("bookingForm").style.display = "block";

    // Hide the preview until next save
    document.getElementById("mainBookingPreview").style.display = "none";

    // Hide Add More button until next booking saved
    document.getElementById("addMoreBtn").style.display = "none";
}
  function addSubBooking() {
    let custNumber = document.getElementById("custNumber").value.trim();
    if (!custNumber) {
        alert("Customer number missing!");
        return;
    }

    // Call backend to fetch latest main booking
    fetch(`${API_URL}?action=getMainBooking&customerNumber=${custNumber}`)
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert("No main booking found to copy details.");
                return;
            }

            // Clear all fields except customer number
            document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea")
                .forEach(el => {
                    if (el.id === "custNumber" || el.type === "hidden") return;
                    if (el.tagName.toLowerCase() === "select") {
                        el.selectedIndex = 0;
                    } else {
                        el.value = "";
                    }
                });

            // ‚úÖ Reset dynamic sections (tests/packages)
            document.getElementById("selectedTestsBody").innerHTML = "";
            document.getElementById("selectedPackagesBody").innerHTML = "";

            // ‚úÖ Reset totals
            document.getElementById("totalAmount").value = "";
            document.getElementById("techCharge").value = "";
            document.getElementById("totalToPay").value = "";
            document.getElementById("discountList").value = "0";

           // ‚úÖ Pre-fill from main booking
document.getElementById("custNumber").value = custNumber;
document.getElementById("address").value    = data.address;
document.getElementById("location").value   = data.location;
document.getElementById("city").value       = data.city;
document.getElementById("phleboList").value = data.phleboName;
document.getElementById("pincode").value    = data.pincode;

// ‚úÖ Fix preferredDate (convert to YYYY-MM-DD for input type="date")
if (data.preferredDate) {
    let d = new Date(data.preferredDate);
    let yyyy = d.getFullYear();
    let mm = String(d.getMonth() + 1).padStart(2, "0");
    let dd = String(d.getDate()).padStart(2, "0");
    document.getElementById("prefDate").value = `${yyyy}-${mm}-${dd}`;
}

// ‚úÖ Fix preferredTime (input type="time" expects HH:MM in 24hr format)
if (data.preferredTime) {
    document.getElementById("prefTime").value = data.preferredTime;
}

// ‚úÖ Freeze those fields
["custNumber","address","location","city","phleboList","pincode","prefDate","prefTime"].forEach(id => {
    let el = document.getElementById(id);
    if (!el) return;

    if (el.tagName.toLowerCase() === "select" || el.type === "date" || el.type === "time") {
        el.disabled = true;  // disable select/date/time inputs
    } else {
        el.readOnly = true;  // readonly for text/textarea
    }
    el.style.backgroundColor = "#f0f0f0"; // greyed out
});
            // ‚úÖ Show booking form again
            document.getElementById("bookingForm").style.display = "block";

            // ‚úÖ Keep Add More button visible
            document.getElementById("addMoreBtn").style.display = "inline-block";
        })
        .catch(err => {
            console.error("Error fetching main booking:", err);
            alert("Could not fetch main booking details.");
        });
}
</script>
</body>
</html>
