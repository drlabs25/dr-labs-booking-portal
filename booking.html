<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Booking</title>
<link rel="stylesheet" href="style.css">
<script src="script.js"></script>
<style>
.small-btn { padding: 5px 10px; font-size: 12px; border-radius: 50%; border: none; cursor: pointer; }
.cancel { background: red; color: white; }
.edit { background: orange; color: white; }
.paid { background: green; color: white; }
.flex { display: flex; gap: 10px; flex-wrap: wrap; }
.flex input, .flex select { flex: 1; }
    .booking-summary {
    background: #eef;
    padding: 10px;
    margin: 15px 0; /* spacing around */
    border-radius: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}
.booking-summary strong {
    margin-right: 8px;
}
</style>
</head>
<body>
<button class="nav-btn back" onclick="goBack()">Back</button>
<button class="nav-btn home" onclick="goHome()">Home</button>
<div class="container">
<h2>Booking Form</h2>

<!-- Search Section -->
<div class="flex">
    <input type="number" id="custNumber" placeholder="Customer Number (10 digits)" maxlength="10" oninput="validateCustomerNumber(this)">
    <button onclick="searchCustomer()">Search</button>
    <button id="createBookingBtn" onclick="validateAndShowBookingForm()" disabled>Create Booking</button>
</div>

<!-- Booking Form (hidden by default) -->
<!-- Booking History -->
<div id="history" style="display:none;">
    <h3>Booking History</h3>
    <div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Customer Number</th>
                <th>Customer Name</th>
                <th>Preferred Date & Time</th>
                <th>Technician Name</th>
                <th>Created Date & Time</th>
                <th>Agent Name</th>
                <th>Status</th>
                <th>Edit</th>
                <th>Cancel</th>
                <th>Paid</th>
            </tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
    </div>
</div>

<!-- Booking Form Fields -->
<div id="bookingForm" style="display:none;">
    <h3>New Booking</h3>
    <!-- Hidden bookingId for edit mode -->
    <input type="hidden" id="bookingId">
    
    <input type="text" id="custName" placeholder="Main Customer Name" required>
    <input type="date" id="dob" placeholder="Date of Birth" onchange="calcAge()">
    <input type="number" id="age" placeholder="Age" required>
    <select id="gender">
        <option>Male</option>
        <option>Female</option>
    </select>
    <textarea id="address" placeholder="Address" maxlength="500" required></textarea>
    <input type="text" id="location" placeholder="Location" maxlength="100" required>
    <select id="city">
        <option>Chennai</option>
        <option>Bangalore</option>
        <option>Hyderabad</option>
        <option>Mumbai</option>
        <option>Delhi</option>
        <option>Coimbatore</option>
    </select>
    <select id="phleboList" onchange="checkPhleboAvailability()">
        <option value="">--Select Phlebo--</option>
    </select>
    <input type="number" id="pincode" placeholder="Pincode (6 digits)" maxlength="6" required>
    <input type="date" id="prefDate" min="" onchange="checkPhleboAvailability()">
    <select id="prefTime" onchange="checkPhleboAvailability()"></select>

    <!-- Test selection -->
    <label>Tests</label>
    <input type="text" placeholder="Search Test" oninput="loadTests(this.value)">
    <div id="testList"></div>
    <div id="selectedTests">
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr>
                    <th>Test Name</th>
                    <th>Cost</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="selectedTestsBody"></tbody>
        </table>
    </div>
<!-- Main Booking Preview Table -->
<div id="mainBookingPreview" style="display:none; float:right; width:35%; margin-top:20px;">
    <h3>Main Booking</h3>
    <table border="1" style="width:100%;">
        <thead>
            <tr>
                <th>Customer Name</th>
                <th>Preferred Date & Time</th>
                <th>Total Cost</th>
            </tr>
        </thead>
        <tbody id="mainBookingPreviewBody"></tbody>
    </table>
</div>
    <!-- Package selection -->
    <label>Packages</label>
    <input type="text" placeholder="Search Package" oninput="loadPackages(this.value)">
    <div id="packageList"></div>
    <div id="selectedPackages">
        <table border="1" style="width:100%; margin-top:5px;">
            <thead>
                <tr>
                    <th>Package Name</th>
                    <th>Cost</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="selectedPackagesBody"></tbody>
        </table>
    </div>

    <input type="number" id="totalAmount" placeholder="Total Amount" readonly>

    <select id="discountList" onchange="recalculateTotal()">
        <option value="0">No Discount</option>
        <option value="5">5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20">20%</option>
    </select>

    <input type="number" id="techCharge" placeholder="Technician Charge" oninput="recalculateTotal()">
    <input type="number" id="totalToPay" placeholder="Total Amount to be Paid" readonly>

    <button onclick="createBooking()">Submit</button>
    <button onclick="addSubBooking(document.getElementById('bookingId').value)">Sub Booking</button>
    <button onclick="confirmBooking()">Confirm Booking</button>
</div>
</div>

<script>
window.onload = function() {
    let today = new Date().toISOString().split("T")[0];
    document.getElementById("prefDate").setAttribute("min", today);

    let timeSelect = document.getElementById('prefTime');
    let startHour = 6, endHour = 18;
    for (let h = startHour; h < endHour; h++) {
        let times = [`${h}:00`, `${h}:30`];
        for (let i = 0; i < times.length; i++) {
            let nextH = h + (i === 0 ? 0 : 1);
            let nextM = (i === 0 ? ":30" : ":00");
            let display = `${times[i]} - ${nextH}${nextM}`;
            let opt = document.createElement("option");
            opt.text = display;
            timeSelect.add(opt);
        }
    }
    loadPhlebos();
};

function validateCustomerNumber(input) {
    input.value = input.value.replace(/[^0-9]/g, '');
    document.getElementById("createBookingBtn").disabled = (input.value.length !== 10);
}

function validateAndShowBookingForm() {
    let custNumber = document.getElementById("custNumber").value.trim();
    if (custNumber.length !== 10 || !/^\d+$/.test(custNumber)) {
        alert("Please enter a valid 10-digit Customer Number before creating a booking.");
        return;
    }

    document.getElementById("bookingForm").style.display = "block";
    window.scrollTo({
        top: document.getElementById("bookingForm").offsetTop,
        behavior: 'smooth'
    });
}
function showBookingForm() {
    document.getElementById("bookingForm").style.display = 'block';
    document.getElementById("history").style.display = 'none';
}
function loadTests(query) {
    query = (query || "").trim();
    if (query.length < 2) {
        document.getElementById("testList").innerHTML = "";
        return;
    }
    fetch(`${API_URL}?action=getTests&search=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(tests => {
            let html = "";
            tests.forEach(t => {
                html += `<div><button type="button" onclick="addSelectedTest('${t.code}','${t.name}','${t.cost}')">${t.name} - ₹${t.cost}</button></div>`;
            });
            document.getElementById("testList").innerHTML = html;
        });
}

function loadPackages(query) {
    query = (query || "").trim();
    if (query.length < 2) {
        document.getElementById("packageList").innerHTML = "";
        return;
    }
    fetch(`${API_URL}?action=getPackages&search=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(packages => {
            let html = "";
            packages.forEach(p => {
                html += `<div><button type="button" onclick="addSelectedPackage('${p.code}','${p.name}','${p.cost}')">${p.name} - ₹${p.cost}</button></div>`;
            });
            document.getElementById("packageList").innerHTML = html;
        });
}

function addSelectedTest(code, name, cost) {
    if (!document.getElementById("test_" + code)) {
        let tr = document.createElement("tr");
        tr.id = "test_" + code;
        tr.innerHTML = `
            <td>${name}</td>
            <td>₹${cost}</td>
            <td><button type="button" onclick="removeSelected('test_${code}')">Remove</button></td>
            <input type="hidden" class="selected-test" value="${code}|${cost}">
        `;
        document.getElementById("selectedTestsBody").appendChild(tr);
    }
    document.getElementById("testList").innerHTML = "";
    recalculateTotal();
}

function addSelectedPackage(code, name, cost) {
    if (!document.getElementById("package_" + code)) {
        let tr = document.createElement("tr");
        tr.id = "package_" + code;
        tr.innerHTML = `
            <td>${name}</td>
            <td>₹${cost}</td>
            <td><button type="button" onclick="removeSelected('package_${code}')">Remove</button></td>
            <input type="hidden" class="selected-package" value="${code}|${cost}">
        `;
        document.getElementById("selectedPackagesBody").appendChild(tr);
    }
    document.getElementById("packageList").innerHTML = "";
    recalculateTotal();
}

function removeSelected(id) {
    document.getElementById(id).remove();
    recalculateTotal();
}

function calcAge() {
    let dob = document.getElementById("dob").value;
    if (dob) {
        let birth = new Date(dob);
        let today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        let m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        document.getElementById("age").value = age;
    }
}

function recalculateTotal() {
    let testsCost = 0;
    document.querySelectorAll(".selected-test").forEach(item => {
        testsCost += parseFloat(item.value.split("|")[1]) || 0;
    });

    let packagesCost = 0;
    document.querySelectorAll(".selected-package").forEach(item => {
        packagesCost += parseFloat(item.value.split("|")[1]) || 0;
    });

    let totalAmount = testsCost + packagesCost;
    document.getElementById("totalAmount").value = totalAmount.toFixed(2);

    let discountPercent = parseFloat(document.getElementById("discountList").value) || 0;
    let techCharge = parseFloat(document.getElementById("techCharge").value) || 0;

    let discountedPart = (totalAmount - packagesCost) - ((discountPercent / 100) * (totalAmount - packagesCost));
    let totalToPay = discountedPart + packagesCost + techCharge;

    document.getElementById("totalToPay").value = totalToPay.toFixed(2);
}

function searchCustomer() {
    let custNumber = document.getElementById("custNumber").value.trim();
    if (custNumber.length !== 10 || !/^\d+$/.test(custNumber)) {
        alert("Please enter a valid 10-digit number");
        return;
    }
    // After successful search
    document.getElementById("createBookingBtn").disabled = false;
}
    fetch(`${API_URL}?action=searchBookings&customerNumber=${encodeURIComponent(num)}`)
        .then(res => res.json())
        .then(bookings => {
            const body = document.getElementById("historyBody");
            body.innerHTML = "";
            if (bookings.length === 0) {
                alert("No booking history for this number");
                return;
            }
            document.getElementById("history").style.display = 'block';
            bookings.forEach(b => {
                const tr = document.createElement("tr");

                if (b.status && b.status.toLowerCase() === "paid") {
                    tr.style.backgroundColor = "lightgreen";
                } else if (b.status && b.status.toLowerCase() === "cancel") {
                    tr.style.backgroundColor = "lightcoral";
                    tr.style.color = "white";
                } else if (b.status && b.status.toLowerCase() === "confirm") {
                    tr.style.backgroundColor = "lightblue";
                }

                tr.innerHTML = `
                    <td>${b.customerNumber}</td>
                    <td>${b.name}</td>
                    <td>${b.dateTime}</td>
                    <td>${b.phlebo}</td>
                    <td>${b.agent}</td>
                    <td>${b.createdDateTime}</td>
                    <td>${b.status || ''}</td>
                    <td><button class="small-btn edit" onclick="editBooking('${b.bookingId}')">E</button></td>
                    <td><button class="small-btn cancel" onclick="updateStatus('${b.bookingId}','Cancel')">X</button></td>
                    <td><button class="small-btn paid" onclick="updateStatus('${b.bookingId}','Paid')">P</button></td>
                `;
                body.appendChild(tr);
            });
        });
}

// ✅ Updated: Instant color change when status updates
function updateStatus(bookingId, status) {
    if (!confirm(`Are you sure you want to mark this booking as ${status}?`)) return;

    fetch(`${API_URL}?action=updateBookingStatus&bookingId=${encodeURIComponent(bookingId)}&status=${encodeURIComponent(status)}&t=${Date.now()}`)
        .then(res => res.json())
        .then(data => {
            console.log("Update Status Response:", data);
            if (data.success) {
                alert(`Booking marked as ${status}`);

                let row = [...document.querySelectorAll("#historyBody tr")]
                    .find(tr => tr.innerHTML.includes(bookingId));

                if (row) {
                    let statusCell = row.querySelector("td:nth-child(7)");
                    if (statusCell) statusCell.textContent = status;

                    if (status.toLowerCase() === "paid") {
                        row.style.backgroundColor = "lightgreen";
                        row.style.color = "";
                    } else if (status.toLowerCase() === "cancel") {
                        row.style.backgroundColor = "lightcoral";
                        row.style.color = "white";
                    } else if (status.toLowerCase() === "confirm") {
                        row.style.backgroundColor = "lightblue";
                        row.style.color = "";
                    }
                }
            } else {
                alert("Failed to update status: " + (data.message || "Unknown error"));
            }
        })
        .catch(err => {
            console.error("Error updating status:", err);
            alert("Error updating status. Check console for details.");
        });
}

function showBookingForm() {
    document.getElementById("bookingForm").style.display = 'block';
}

function createBooking() {
    // Reset all borders first
    document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea")
        .forEach(el => el.style.border = "");

    let isValid = true;
    function markInvalid(id) {
        document.getElementById(id).style.border = "2px solid red";
        isValid = false;
    }

    let custNumber = document.getElementById("custNumber").value.trim();
    if (custNumber.length !== 10 || !/^\d+$/.test(custNumber)) markInvalid("custNumber");
    if (!document.getElementById("custName").value.trim()) markInvalid("custName");
    if (!document.getElementById("age").value.trim()) markInvalid("age");
    if (!document.getElementById("gender").value) markInvalid("gender");
    if (!document.getElementById("address").value.trim()) markInvalid("address");
    if (!document.getElementById("location").value.trim()) markInvalid("location");
    if (!document.getElementById("city").value) markInvalid("city");
    if (!document.getElementById("phleboList").value) markInvalid("phleboList");

    let pincode = document.getElementById("pincode").value.trim();
    if (pincode.length !== 6 || !/^\d+$/.test(pincode)) markInvalid("pincode");
    if (!document.getElementById("prefDate").value) markInvalid("prefDate");
    if (!document.getElementById("prefTime").value) markInvalid("prefTime");

    let tests = getSelectedTests();
    let packages = getSelectedPackages();
    if (!tests && !packages) {
        document.querySelector("#testList")?.style.setProperty("border", "2px solid red", "important");
        document.querySelector("#packageList")?.style.setProperty("border", "2px solid red", "important");
        isValid = false;
    }

    if (!document.getElementById("discountList").value) markInvalid("discountList");
    if (!document.getElementById("techCharge").value.trim()) markInvalid("techCharge");

    if (!isValid) {
        alert("Please fill all required fields.");
        return;
    }

    // Prepare params for Google Sheet
    let params = new URLSearchParams({
        action: "saveBooking",
        customerNumber: custNumber,
        mainCustomerName: document.getElementById("custName").value.trim(),
        dob: document.getElementById("dob").value,
        age: document.getElementById("age").value.trim(),
        gender: document.getElementById("gender").value,
        address: document.getElementById("address").value.trim(),
        location: document.getElementById("location").value.trim(),
        city: document.getElementById("city").value,
        phleboName: document.getElementById("phleboList").value,
        pincode: pincode,
        preferredDate: document.getElementById("prefDate").value,
        preferredTime: document.getElementById("prefTime").value,
        tests: tests,
        packages: packages,
        totalAmount: document.getElementById("totalAmount").value,
        discount: document.getElementById("discountList").value,
        techCharge: document.getElementById("techCharge").value,
        totalToPay: document.getElementById("totalToPay").value,
        agentName: "Agent Name Here"
    });

    fetch(`${API_URL}?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
    // Minimize booking form
    document.getElementById("bookingForm").style.display = "none";

    // Show summary at top
    document.getElementById("summaryContainer").innerHTML = `
        <div class="booking-summary">
            <div>
                <strong>${document.getElementById("custName").value}</strong> |
                ${document.getElementById("prefDate").value} ${document.getElementById("prefTime").value} |
                ₹${document.getElementById("totalToPay").value}
            </div>
            <button onclick="showSubBookingForm()">+ Add Sub Booking</button>
        </div>
    `;

} else {
    alert("Failed to save booking.");
}
                // Collapse form into summary
                let custName = document.getElementById("custName").value.trim();
                let date = document.getElementById("prefDate").value;
                let time = document.getElementById("prefTime").value;
                let cost = document.getElementById("totalToPay").value;

                document.getElementById("bookingForm").style.display = "none";

                let summaryHTML = `
    <div class="booking-summary">
        <div>
            <strong>Main Booking:</strong> ${custName} | ${date} ${time} | ₹${cost}
        </div>
        <button onclick="showSubBookingForm()">+ Add Sub Booking</button>
    </div>
`;
                let summaryContainer = document.getElementById("summaryContainer");
                if (!summaryContainer) {
                    summaryContainer = document.createElement("div");
                    summaryContainer.id = "summaryContainer";
                    document.querySelector(".container").prepend(summaryContainer);
                }
                summaryContainer.innerHTML = summaryHTML;

            } else {
                alert("Failed to save booking.");
            }
        });
}

function showSubBookingForm() {
    // Show booking form again but freeze shared fields
    document.getElementById("bookingForm").style.display = "block";

    ["address", "location", "city", "pincode", "prefDate", "prefTime", "phleboList"]
        .forEach(id => document.getElementById(id).setAttribute("readonly", true));
}
function addSubBooking() {
    let custNum = document.getElementById("custNumber").value.trim();
    if (custNum.length !== 10) {
        alert("Enter a valid 10-digit Customer Number before creating sub-booking.");
        return;
    }

    fetch(`${API_URL}?action=getMainBooking&customerNumber=${encodeURIComponent(custNum)}`)
        .then(res => res.json())
        .then(data => {
            if (!data || data.success === false) {
                alert("Main booking not found");
                return;
            }

            // Fill frozen fields from main booking
            document.getElementById("address").value = data.address;
            document.getElementById("location").value = data.location;
            document.getElementById("city").value = data.city;
            document.getElementById("phleboList").value = data.phleboName;
            document.getElementById("pincode").value = data.pincode;
            document.getElementById("prefDate").value = data.preferredDate;
            document.getElementById("prefTime").value = data.preferredTime;

            // Make frozen fields read-only
            ["address", "location", "city", "phleboList", "pincode", "prefDate", "prefTime"]
                .forEach(id => document.getElementById(id).setAttribute("disabled", true));

            // Clear other fields
            document.querySelectorAll("#bookingForm input, #bookingForm select, #bookingForm textarea").forEach(el => {
                if (!["custNumber", "address", "location", "city", "phleboList", "pincode", "prefDate", "prefTime"].includes(el.id)) {
                    el.value = "";
                }
            });

            document.getElementById("bookingForm").style.display = "block";
        })
        .catch(err => {
            console.error(err);
            alert("Error fetching main booking details.");
        });
}
function editBooking(bookingId) {
    fetch(`${API_URL}?action=getBookingDetails&bookingId=${bookingId}`)
        .then(res => res.json())
        .then(data => {
            if (!data || data.success === false) {
                alert("Booking not found");
                return;
            }
            document.getElementById("bookingId").value = bookingId;
            document.getElementById("custNumber").value = data.customerNumber;
            document.getElementById("custName").value = data.mainCustomerName;
            document.getElementById("dob").value = data.dob;
            document.getElementById("age").value = data.age;
            document.getElementById("gender").value = data.gender;
            document.getElementById("address").value = data.address;
            document.getElementById("location").value = data.location;
            document.getElementById("city").value = data.city;
            document.getElementById("phleboList").value = data.phleboName;
            document.getElementById("pincode").value = data.pincode;
            document.getElementById("prefDate").value = data.preferredDate;
            document.getElementById("prefTime").value = data.preferredTime;
            document.getElementById("totalAmount").value = data.totalAmount;
            document.getElementById("discountList").value = data.discount;
            document.getElementById("techCharge").value = data.techCharge;
            document.getElementById("totalToPay").value = data.totalToPay;

            showBookingForm();
        });
}

function getSelectedTests() {
    let tests = [];
    document.querySelectorAll(".selected-test").forEach(item => {
        tests.push(item.value);
    });
    return tests.join(",");
}

function getSelectedPackages() {
    let packages = [];
    document.querySelectorAll(".selected-package").forEach(item => {
        packages.push(item.value);
    });
    return packages.join(",");
}

function loadPhlebos() {
    fetch(`${API_URL}?action=getPhlebos`)
        .then(res => res.json())
        .then(phlebos => {
            let phleboSelect = document.getElementById("phleboList");
            phlebos.forEach(phlebo => {
                let opt = document.createElement("option");
                opt.value = phlebo.name;
                opt.textContent = phlebo.name;
                phleboSelect.appendChild(opt);
            });
        });
}

function checkPhleboAvailability() {
    let phlebo = document.getElementById("phleboList").value;
    let date = document.getElementById("prefDate").value;
    let time = document.getElementById("prefTime").value;
    let bookingId = document.getElementById("bookingId").value; // added

    if (!phlebo || !date || !time) return;

    fetch(`${API_URL}?action=checkAvailability&phlebo=${encodeURIComponent(phlebo)}&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}&bookingId=${encodeURIComponent(bookingId)}`)
        .then(res => res.json())
        .then(data => {
            if (!data.available) {
                alert("Preferred time not available for this technician. Please choose another time.");
            }
        });
}
<script>
    function validateAndShowBookingForm() {
    let custNumber = document.getElementById("custNumber").value.trim();
    if (custNumber.length !== 10 || !/^\d+$/.test(custNumber)) {
        alert("Please enter a valid 10-digit Customer Number before creating a booking.");
        return;
    }

    // Show booking form
    document.getElementById("bookingForm").style.display = "block";
    window.scrollTo({ top: document.getElementById("bookingForm").offsetTop, behavior: 'smooth' });
}
</script>
</body>
</html>
