<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Report</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { margin-right: 10px; }
    select, input { margin-right: 15px; padding: 5px; }
    button { padding: 6px 12px; margin-top: 10px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    tr.total-row { font-weight: bold; background: #e0e0e0; }
  </style>
</head>
<body>

<h2>Admin Report</h2>

<div>
  <label for="dateType">Date Filter:</label>
  <select id="dateType">
    <option value="created">Created Date</option>
    <option value="preferred">Slot Date</option>
  </select>

  <label for="fromDate">From:</label>
  <input type="date" id="fromDate" />

  <label for="toDate">To:</label>
  <input type="date" id="toDate" />

  <label for="statusFilter">Status:</label>
  <select id="statusFilter">
    <option value="all">All</option>
    <option value="paid">Paid</option>
    <option value="confirm">Confirm</option>
    <option value="cancel">Cancel</option>
  </select>

  <button onclick="applyFilter()">Apply Filter</button>
</div>

<table id="reportTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Total Bookings</th>
      <th>Total Paid</th>
      <th>Total Confirm</th>
      <th>Total Cancel</th>
      <th>Total To Pay</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4sBOSu5WL_Cep7M1B9qYgfvBSQ0iuuCfbrRQDG6y4qPl6fJfap-4LLaX_wMqvg3ZV8A/exec";

  // Parse money string like "₹1,550" or "1550" safely
  function parseMoney(val) {
    return parseFloat((val || "0").toString().replace(/[₹,]/g, "").trim()) || 0;
  }

  // Normalize any date string to "YYYY-MM-DD" format or return empty string
  function normalizeDate(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return "";
    return d.toISOString().slice(0, 10);
  }

  // CSV parser that handles commas inside quotes, returns array of objects
  function parseCSV(csv) {
    const lines = csv.trim().split(/\r?\n/);
    if (lines.length < 2) return [];

    const headers = parseCSVLine(lines[0]);

    return lines.slice(1).map(line => {
      const values = parseCSVLine(line);
      const obj = {};
      headers.forEach((h, i) => obj[h] = values[i] ? values[i].trim() : "");
      return obj;
    }).filter(r => r["Status"] && r["Status"].toLowerCase() !== "status");
  }

  // Parse single CSV line considering quotes
  function parseCSVLine(line) {
    const result = [];
    let current = "";
    let insideQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"' && line[i + 1] === '"') {
        current += '"'; // escaped quote
        i++;
      } else if (char === '"') {
        insideQuotes = !insideQuotes;
      } else if (char === ',' && !insideQuotes) {
        result.push(current);
        current = "";
      } else {
        current += char;
      }
    }
    result.push(current);
    return result;
  }

  async function applyFilter() {
    const dateType = document.getElementById("dateType").value;
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;
    const statusFilter = document.getElementById("statusFilter").value.toLowerCase();

    if (!fromDate || !toDate) {
      alert("Please select both From and To dates.");
      return;
    }

    const params = new URLSearchParams();
    params.append("action", "getReportCSV");
    if (dateType === "created") {
      params.append("createdStart", fromDate);
      params.append("createdEnd", toDate);
    } else {
      params.append("prefStart", fromDate);
      params.append("prefEnd", toDate);
    }

    try {
      const res = await fetch(`${WEB_APP_URL}?${params.toString()}`);
      if (!res.ok) throw new Error(`Network error: ${res.status}`);

      const csvText = await res.text();

      console.log("Raw CSV data:\n", csvText);

      const data = parseCSV(csvText);

      console.log("Parsed data objects:", data);

      if (!data.length) {
        renderEmpty("No records found for the applied filters.");
        return;
      }

      renderTable(data, statusFilter, dateType, fromDate, toDate);
    } catch (err) {
      console.error("Fetch Error:", err);
      renderEmpty("⚠️ Unable to fetch data. Please check your Web App URL or permissions.");
    }
  }

  function renderEmpty(msg) {
    document.querySelector("#reportTable tbody").innerHTML =
      `<tr><td colspan="6">${msg}</td></tr>`;
  }

  function renderTable(data, statusFilter, dateType, fromDate, toDate) {
    const tbody = document.querySelector("#reportTable tbody");
    tbody.innerHTML = "";

    const grouped = {};

    // Convert filter dates to Date objects for comparison
    const from = new Date(fromDate);
    const to = new Date(toDate);

    data.forEach(row => {
      // Determine date field and normalize it
      const dateRaw = dateType === "created" ? row["Created On"] : row["Preferred Date"];
      const date = normalizeDate(dateRaw);
      if (!date) return;

      // Check if date is within range inclusive
      const dateObj = new Date(date);
      if (dateObj < from || dateObj > to) return;

      const status = (row["Status"] || "").toLowerCase();

      // Apply status filter
      if (statusFilter !== "all" && status !== statusFilter) return;

      const toPay = parseMoney(row["Total To Pay"]);

      if (!grouped[date]) {
        grouped[date] = {
          totalBookings: 0,
          paid: 0,
          confirm: 0,
          cancel: 0,
          totalToPay: 0,
        };
      }

      grouped[date].totalBookings++;
      if (status === "paid") grouped[date].paid++;
      else if (status === "confirm") grouped[date].confirm++;
      else if (status === "cancel") grouped[date].cancel++;

      grouped[date].totalToPay += toPay;
    });

    const dates = Object.keys(grouped).sort();

    if (!dates.length) {
      renderEmpty("No matching records found.");
      return;
    }

    const grandTotals = {
      totalBookings: 0,
      paid: 0,
      confirm: 0,
      cancel: 0,
      totalToPay: 0,
    };

    dates.forEach(date => {
      const g = grouped[date];
      grandTotals.totalBookings += g.totalBookings;
      grandTotals.paid += g.paid;
      grandTotals.confirm += g.confirm;
      grandTotals.cancel += g.cancel;
      grandTotals.totalToPay += g.totalToPay;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${date}</td>
        <td>${g.totalBookings}</td>
        <td>${g.paid}</td>
        <td>${g.confirm}</td>
        <td>${g.cancel}</td>
        <td>₹${g.totalToPay.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });

    // Total row
    const totalRow = document.createElement("tr");
    totalRow.classList.add("total-row");
    totalRow.innerHTML = `
      <td>Total</td>
      <td>${grandTotals.totalBookings}</td>
      <td>${grandTotals.paid}</td>
      <td>${grandTotals.confirm}</td>
      <td>${grandTotals.cancel}</td>
      <td>₹${grandTotals.totalToPay.toFixed(2)}</td>
    `;
    tbody.appendChild(totalRow);
  }

  renderEmpty("No records yet — please apply a filter.");
</script>

</body>
</html>
