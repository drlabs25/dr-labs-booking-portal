<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Report</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  h2 { text-align: center; margin-bottom: 20px; }
  .filter-section { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
  label { font-weight: bold; }
  select, input[type="date"] { padding: 5px; font-size: 14px; }
  button { padding: 8px 16px; font-size: 14px; cursor: pointer; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background-color: #f0f0f0; }
</style>
</head>
<body>

<h2>Admin Report</h2>

<div class="filter-section">
  <div>
    <label>Date Type:</label>
    <select id="dateType">
      <option value="created">Created Date</option>
      <option value="slot">Slot Date</option>
    </select>
  </div>

  <div>
    <label>From:</label>
    <input type="date" id="fromDate">
  </div>

  <div>
    <label>To:</label>
    <input type="date" id="toDate">
  </div>

  <div>
    <label>Status:</label>
    <select id="statusFilter">
      <option value="all">All</option>
      <option value="paid">Paid</option>
      <option value="confirm">Confirm</option>
      <option value="cancel">Cancel</option>
    </select>
  </div>

  <div>
    <button onclick="applyFilter()">Apply Filter</button>
  </div>
</div>

<table id="reportTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Total Bookings</th>
      <th>Total Paid</th>
      <th>Total Confirm</th>
      <th>Total Cancel</th>
      <th>Total To Pay</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbw4sBOSu5WL_Cep7M1B9qYgfvBSQ0iuuCfbrRQDG6y4qPl6fJfap-4LLaX_wMqvg3ZV8A/exec"; // Replace with your Google Apps Script Web App URL

async function applyFilter() {
  const dateType = document.getElementById('dateType').value;
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  const status = document.getElementById('statusFilter').value;

  if (!from || !to) {
    alert("Please select both From and To dates.");
    return;
  }

  // Prepare query parameters
  const query = new URLSearchParams({
    action: 'getReport',
    createdStart: dateType === 'created' ? from : '',
    createdEnd: dateType === 'created' ? to : '',
    prefStart: dateType === 'slot' ? from : '',
    prefEnd: dateType === 'slot' ? to : '',
    statusFilter: status
  });

  try {
    const res = await fetch(`${webAppUrl}/exec?${query}`);
    const data = await res.json();
    renderTable(data, status);
  } catch (err) {
    console.error(err);
    alert("Failed to fetch report.");
  }
}

function renderTable(data, statusFilter) {
  const tbody = document.querySelector('#reportTable tbody');
  tbody.innerHTML = "";

  let totalBookings = 0;
  let totalPaid = 0;
  let totalConfirm = 0;
  let totalCancel = 0;
  let totalToPaySum = 0;

  data.forEach(row => {
    const rowStatus = row.status ? row.status.toLowerCase() : '';
    if (statusFilter !== 'all' && rowStatus !== statusFilter) return;

    totalBookings++;
    if (rowStatus === 'paid') totalPaid++;
    if (rowStatus === 'confirm') totalConfirm++;
    if (rowStatus === 'cancel') totalCancel++;
    totalToPaySum += parseFloat(row.totalToPay || 0);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.date || (row.createdOn || row.preferredDate)}</td>
      <td>1</td>
      <td>${rowStatus === 'paid' ? 1 : 0}</td>
      <td>${rowStatus === 'confirm' ? 1 : 0}</td>
      <td>${rowStatus === 'cancel' ? 1 : 0}</td>
      <td>${row.totalToPay || 0}</td>
    `;
    tbody.appendChild(tr);
  });

  // Add summary row
  const tr = document.createElement('tr');
  tr.style.fontWeight = "bold";
  tr.innerHTML = `
    <td>Total</td>
    <td>${totalBookings}</td>
    <td>${totalPaid}</td>
    <td>${totalConfirm}</td>
    <td>${totalCancel}</td>
    <td>${totalToPaySum.toFixed(2)}</td>
  `;
  tbody.appendChild(tr);
}
</script>

</body>
</html>
