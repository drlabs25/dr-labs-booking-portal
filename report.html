<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Report</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #fafafa; }
    label { margin-right: 10px; font-weight: 600; }
    select, input { margin-right: 15px; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 8px 14px; margin-top: 10px; cursor: pointer; background: #007BFF; color: white; border: none; border-radius: 4px; }
    button:hover { background: #0056b3; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #f4f4f4; }
    tr.total-row { font-weight: bold; background: #e0e0e0; }
    #noDataMessage { margin-top: 20px; color: #666; font-style: italic; display: none; }
  </style>
</head>
<body>

<h2>Admin Report</h2>

<div>
  <label for="dateType">Date Filter:</label>
  <select id="dateType">
    <option value="created">Created Date</option>
    <option value="preferred">Slot Date</option>
  </select>

  <label for="fromDate">From:</label>
  <input type="date" id="fromDate" />

  <label for="toDate">To:</label>
  <input type="date" id="toDate" />

  <label for="statusFilter">Status:</label>
  <select id="statusFilter">
    <option value="all">All</option>
    <option value="paid">Paid</option>
    <option value="confirm">Confirm</option>
    <option value="cancel">Cancel</option>
  </select>

  <button onclick="applyFilter()">Apply Filter</button>
</div>

<div id="noDataMessage">No records to display. Please apply filters to see the report.</div>

<table id="reportTable" style="display:none;">
  <thead>
    <tr>
      <th>Date</th>
      <th>Total Bookings</th>
      <th>Total Paid</th>
      <th>Total Confirm</th>
      <th>Total Cancel</th>
      <th>Total To Pay</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4sBOSu5WL_Cep7M1B9qYgfvBSQ0iuuCfbrRQDG6y4qPl6fJfap-4LLaX_wMqvg3ZV8A/exec";

  async function applyFilter() {
    const dateType = document.getElementById("dateType").value;
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;
    const statusFilter = document.getElementById("statusFilter").value;
    const noDataMessage = document.getElementById("noDataMessage");
    const reportTable = document.getElementById("reportTable");

    if (!fromDate || !toDate) {
      alert("Please select both From and To dates.");
      return;
    }

    const params = new URLSearchParams();
    params.append("action", "getReport");
    if (dateType === "created") {
      params.append("createdStart", fromDate);
      params.append("createdEnd", toDate);
    } else {
      params.append("prefStart", fromDate);
      params.append("prefEnd", toDate);
    }

    try {
      const res = await fetch(`${WEB_APP_URL}?${params.toString()}`);
      const data = await res.json();
      console.log("Fetched Data:", data);
      if (!data || data.length === 0) {
        noDataMessage.style.display = "block";
        reportTable.style.display = "none";
        return;
      }
      noDataMessage.style.display = "none";
      reportTable.style.display = "table";
      renderTable(data, statusFilter, dateType);
    } catch (err) {
      console.error("Fetch Error:", err);
      alert("Error fetching report.");
    }
  }

  function renderTable(data, statusFilter, dateType) {
    const tbody = document.querySelector("#reportTable tbody");
    tbody.innerHTML = "";

    let totalBookings = 0;
    let totalPaid = 0;
    let totalConfirm = 0;
    let totalCancel = 0;
    let totalToPay = 0;

    data.forEach(item => {
      const itemStatus = (item.status || "confirm").toLowerCase();
      if (statusFilter !== "all" && itemStatus !== statusFilter) return;

      let dateRaw = dateType === "created" ? item.createdDate : item.slotDate;
      const displayDate = dateRaw || "-";

      let toPayStr = item.totalToPay || "0";
      const toPay = parseFloat(toPayStr.toString().replace(/[^\d.-]/g, '')) || 0;

      totalBookings++;
      if (itemStatus === "paid") totalPaid++;
      if (itemStatus === "confirm") totalConfirm++;
      if (itemStatus === "cancel") totalCancel++;
      totalToPay += toPay;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${displayDate}</td>
        <td>1</td>
        <td>${itemStatus === "paid" ? 1 : 0}</td>
        <td>${itemStatus === "confirm" ? 1 : 0}</td>
        <td>${itemStatus === "cancel" ? 1 : 0}</td>
        <td>₹${toPay.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });

    if (totalBookings === 0) {
      tbody.innerHTML = `<tr><td colspan="6">No records match the selected filter.</td></tr>`;
      return;
    }

    const totalRow = document.createElement("tr");
    totalRow.classList.add("total-row");
    totalRow.innerHTML = `
      <td>Total</td>
      <td>${totalBookings}</td>
      <td>${totalPaid}</td>
      <td>${totalConfirm}</td>
      <td>${totalCancel}</td>
      <td>₹${totalToPay.toFixed(2)}</td>
    `;
    tbody.appendChild(totalRow);
  }
</script>

</body>
</html>
